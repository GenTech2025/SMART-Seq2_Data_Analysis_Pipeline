---
title: "mouse-pipeline-PCA"
author: "S2599932"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# This pipeline takes in he mouse data and generates two PCA plots one with all genes as features and anothe with only mouse SEGs as features

-   The dataset being used in this code is GSE121708 which is stored in the file path /shared-files/GSE121708 of bioinfmsc6 server.

```{r load_libraries, message=FALSE, warning=FALSE}
library(Seurat)
library(scMerge)
library(SingleCellExperiment)
library(ggplot2)
library(dplyr)
library(biomaRt)
library(corrplot)
library(scater)
library(scran)

library(biomaRt)
library(dplyr)
library(knitr)
```

```{r read_data, message=FALSE, warning=FALSE}
target <- read.table("/home/s2599932/mouse-dataset/GSE121708/sample_metadata.txt", sep = "\t", header = TRUE) # Metadata
cleaned_target <- target[,c("id_rna","sample","stage","plate","embryo","lineage10x")]
rownames(cleaned_target) <- cleaned_target$id_rna
cleaned_target <- su
bset(cleaned_target, select = -1)


raw <- read.table("/home/s2599932/mouse-dataset/GSE121708/counts.txt", header = TRUE, row.names = 1) # Counts data
```

> **NOTE: Ensure that the colnames of counts data frame and rownames of targets file match with each other.**

```{r load_mSEGs, message=FALSE, warning=FALSE}
data("segList_ensemblGeneID", package = "scMerge")
mSEG <- segList_ensemblGeneID$mouse$mouse_scSEG # Extracting SEGs identified in mouse by scRNA Seq
```

> trouble shooing the error which arose due to metadata addition

```{r}
identical(rownames(cleaned_target), colnames(raw)) # returns false

cleaned_target <- cleaned_target[match(colnames(raw), rownames(cleaned_target)), ]

# optionally - rownames(cleaned_target) <- colnames(raw)

```

```{r creating_the_SingleCellExperiment_object, message=FALSE, warning=FALSE}
sce <- SingleCellExperiment(
  assays = list(counts = as.matrix(raw)),
  colData = cleaned_target
)
```

### Initial quality control of cells/samples

```{r calculating_qc_metrics, message=FALSE, warning=FALSE}
is_spike <- grepl("^ERCC",rownames(sce))
mitogenes <- "ENSMUSG00000064336|ENSMUSG00000064337|ENSMUSG00000064338|ENSMUSG00000064339|ENSMUSG00000064340|ENSMUSG00000064341|ENSMUSG00000064342|ENSMUSG00000064343|ENSMUSG00000064344|ENSMUSG00000064345|ENSMUSG00000064346|ENSMUSG00000064347|ENSMUSG00000064348|ENSMUSG00000064349|ENSMUSG00000064350|ENSMUSG00000064351|ENSMUSG00000064352|ENSMUSG00000064353|ENSMUSG00000064354|ENSMUSG00000064355|ENSMUSG00000064356|ENSMUSG00000064357|ENSMUSG00000064358|ENSMUSG00000064359|ENSMUSG00000064360|ENSMUSG00000064361|ENSMUSG00000065947|ENSMUSG00000064363|ENSMUSG00000064364|ENSMUSG00000064365|ENSMUSG00000064366|ENSMUSG00000064367|ENSMUSG00000064368|ENSMUSG00000064369|ENSMUSG00000064370|ENSMUSG00000064371|ENSMUSG00000064372"
is_mito <- grepl(mitogenes, rownames(sce))

sce$qc_stats <- perCellQCMetrics(sce, subsets=list(ERCC=is_spike, Mt=is_mito))
```

#### Quality control plots

```{r fig.height=8, fig.width=8}
hist(sce$qc_stats$sum/1e6, 
     xlab="Library sizes (millions)", 
     main="Histogram of Library Sizes - GSE121708", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
```

```{r fig.height=8, fig.width=8}
hist(sce$qc_stats$detected, 
     xlab="Number of detected genes", 
     main="Histogram of Detected Genes - GSE121708", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
```

```{r fig.height=8, fig.width=8}
hist(sce$qc_stats$subsets_Mt_percent,
     xlab="Mitochondrial proportion (%)", 
     main="Histogram of Mitochondrial Proportion - GSE121708", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
```

```{r fig.height=8, fig.width=8}
hist(sce$qc_stats$subsets_ERCC_percent,
     xlab="ERCC proportion (%)", 
     main="Histogram of ERCC Proportion - GSE121708", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
```

> No spike in genes in the dataset

### Filter the dataset based on quality control metrics

```{r}
# Calculating the filtering metrics
libsize_drop <- isOutlier(sce$qc_stats$sum, nmads = 3, type = "lower", log = TRUE)
feature_drop <- isOutlier(sce$qc_stats$detected, nmads = 3, type = "lower", log = TRUE)
mito_drop <- isOutlier(sce$qc_stats$subsets_Mt_percent, nmads = 3, type = "higher")
spike_drop <- isOutlier(sce$qc_stats$subsets_ERCC_percent, nmads = 3, type = "higher")

sce_copy <- sce # Save a non filtered copy

# Filtering the SingleCellExperiment(SCE) object
sce_fil <- sce[,!(libsize_drop|feature_drop|mito_drop|spike_drop)]
sce_fil_copy <- sce_fil # Save a filtered copy

# Save the filtered cells
filtered_cells <- colnames(sce_fil)

```


## Seurat object workflow

> we should explicitly define that the scaling has to be performed by using all.genes as features.

```{r create_seurat_object}
raw_counts_df <- as.data.frame(sce_fil_copy@assays@data$counts)
seurat_object_raw <- CreateSeuratObject(counts = raw_counts_df)
seurat_object_raw <- AddMetaData(seurat_object_raw, metadata = cleaned_target)
```



```{r susbset_seurat_object}
seurat_object_raw <- seurat_object_raw[,filtered_cells] # Only keep the cells that passed QC
```

> Normalize the data and identify variable features

```{r}
seurat_object_norm <- NormalizeData(seurat_object_raw, verbose = FALSE) # Three options are available for normalization - LogNormalize, CenteredLogRatioTransformation, RelativeCounts

seurat_object_norm <- FindVariableFeatures(seurat_object_norm, selection.method = "vst", verbose = FALSE)

# Need to identify top ten variable features

```


```{r}
# Visualize variable features
VariableFeaturePlot(seurat_object_norm)
```

> VariableFeaturePlot(seurat_object_norm)
Warning in scale_x_log10() :
  log-10 transformation introduced infinite values.


```{r}
seurat_object_norm <- ScaleData(seurat_object_norm, features = rownames(seurat_object_norm), verbose = FALSE)
```


### Perform dimensionality reduction using PCA


```{r}
seurat_object_norm_copy <- seurat_object_norm

# Run PCA using all genes as features
seurat_object_norm <- RunPCA(object = seurat_object_norm, features = rownames(seurat_object_norm), verbose = FALSE )

# Extract the loadings and embeddings
loadings <- Loadings(seurat_object_norm, reduction = "pca")
embeddings <- Embeddings(seurat_object_norm, reduction = "pca")
```

```{r fig.height=14,fig.width=14}
# Generate the plot with enhancements
feature_defined_non_subseted <- DimPlot(seurat_object_norm, reduction = "pca", group.by = "stage") +
    ggtitle("Seurat Normalized + Not Subsetted + Explicit Feature Definition (all genes) - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "B", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(feature_defined_non_subseted)
```



```{r}
seurat_object_norm_copy <- RunPCA(object = seurat_object_norm_copy, verbose = FALSE)
```

```{r fig.height=14,fig.width=14}
# Generate the plot with enhancements
feature_not_defined_non_subseted <- DimPlot(seurat_object_norm_copy, reduction = "pca", group.by = "stage") +
    ggtitle("Seurat Normalized + Not Subsetted + No Explicit Feature Definition - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "H", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(feature_not_defined_non_subseted)
```



```{r}
seurat_object_norm_copy_subset <- subset(seurat_object_norm_copy, features = mSEG)

seurat_object_norm_copy_subset <- RunPCA(seurat_object_norm_copy_subset,features = mSEG, verbose = FALSE)
```


```{r fig.height=14,fig.width=14}
# Generate the plot with enhancements
feature_not_defined_subseted <- DimPlot(seurat_object_norm_copy_subset, reduction = "pca", group.by = "stage") +
    ggtitle("Seurat Normalized + Subsetted + Explicit Feature Definition (mSEG) - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "H", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(feature_not_defined_subseted)
```




### Continue with seurat workflow

```{r fig.height=8, fig.width=8}
# Determine significant PCs
seurat_object_norm <- JackStraw(seurat_object_norm, num.replicate = 100)
seurat_object_norm <- ScoreJackStraw(seurat_object_norm, dims = 1:20)
JackStrawPlot(seurat_object_norm, dims = 1:15)
```



```{r fig.height=8, fig.width=8}
JackStrawPlot(seurat_object_norm, dims = 1:15)
```



```{r fig.height=8, fig.width=8}
ElbowPlot(seurat_object_norm)
```


```{r}
# Find neighbors and clusters
seurat_object_norm <- FindNeighbors(seurat_object_norm, dims = 1:10)
seurat_object_norm <- FindClusters(seurat_object_norm, resolution = 0.5)

# Visualize clusters
DimPlot(seurat_object_norm, reduction = "umap")
```


```{r}
# Run UMAP
seurat_object_norm <- RunUMAP(seurat_object_norm, dims = 1:10)

# Run tSNE
seurat_object_norm <- RunTSNE(seurat_object_norm, dims = 1:10)
```


```{r fig.height=8, fig.width=8}
# Visualize UMAP
DimPlot(seurat_object_norm, reduction = "umap")
```


```{r fig.height=8, fig.width=8}
# Visualize tSNE
DimPlot(seurat_object_norm, reduction = "tsne")
```


```{r fig.height=8, fig.width=8}
# Identify markers for each cluster
cluster_markers <- FindAllMarkers(seurat_object_norm, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)

# Visualize top markers
top10 <- cluster_markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
```


```{r fig.height=18, fig.width=18}

DoHeatmap(seurat_object_norm, features = top10$gene) + NoLegend()
```



```{r}
# Annotate clusters based on known markers
new_cluster_ids <- c("Type1", "Type2", "Type3")
names(new_cluster_ids) <- levels(seurat_object_norm)
seurat_object_norm <- RenameIdents(seurat_object_norm, new_cluster_ids)
```





































## SingleCellExperiment object workflow

### deconvolution normalization


```{r}
clusters <- quickCluster(sce_fil_copy)
sce_fil_copy <- computeSumFactors(sce_fil_copy, clusters = clusters)
sce_fil_copy <- logNormCounts(sce_fil_copy)
```

> https://ucsbcarpentry.github.io/R-markdown/01-why/index.html

### Alternatively we can perform deconvolution normalization using the approach mentioned on this web page [link](https://ucsbcarpentry.github.io/R-markdown/01-why/index.html) 


```{r}
library(scater)
library(scran)
library(sctransform)
library(tidyverse)
library(BiocParallel)
library(patchwork)
bpp <- MulticoreParam(7)
```



```{r}
set.seed(100)
clust <- quickCluster(sce, BPPARAM=bpp)
table(clust)
```



```{r}
sce <- computePooledFactors(sce,
             clusters = clust,
             min.mean = 0.1,
             BPPARAM = bpp)
deconv.sf <- sizeFactors(sce)
summary(deconv.sf)
```



```{r}
lib.sf <- librarySizeFactors(sce)
data.frame(LibrarySizeFactors = lib.sf, 
           DeconvolutionSizeFactors = deconv.sf,
                 SampleGroup = sce$SampleGroup) %>%
  ggplot(aes(x=LibrarySizeFactors, y=DeconvolutionSizeFactors)) +
      geom_point(aes(col=SampleGroup)) +
      geom_abline(slope = 1, intercept = 0)
```



```{r}
sce <- logNormCounts(sce)
assayNames(sce)
```












### Continue with normal pipeline

```{r}
# Extract the normalized data from SCE object
normalized_counts <- assay(sce_fil_copy, "logcounts")

# Create the seurat object 
so_decon_norm <- CreateSeuratObject(counts = normalized_counts)
so_decon_norm <- AddMetaData(so_decon_norm, metadata = cleaned_target)

# Add the normalized data to seurat object
DefaultAssay(so_decon_norm) <- "RNA"
so_decon_norm <- SetAssayData(so_decon_norm, layer = "data", new.data = normalized_counts)

so_decon_norm <- so_decon_norm[,filtered_cells] # Only include cells that passed QC

# Make a copy
so_decon_norm_copy <- so_decon_norm
```



```{r}
so_decon_norm <- FindVariableFeatures(so_decon_norm, selection.method = "vst", verbose = FALSE)

so_decon_norm <- ScaleData(so_decon_norm,features = rownames(so_decon_norm), verbose = FALSE)
```



```{r}
so_decon_norm <- RunPCA(object = so_decon_norm, features = rownames(so_decon_norm), verbose = FALSE)
```



```{r fig.height=14, fig.width=14}
# Generate the plot with enhancements
feature_defined_non_subseted_decon <- DimPlot(seurat_object_norm, reduction = "pca", group.by = "stage") +
    ggtitle("Deconvolution Normalized + Not Subsetted + Explicit Feature Definition (all genes) - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "H", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(feature_defined_non_subseted_decon)
```



```{r}
so_decon_norm_copy <- FindVariableFeatures(so_decon_norm_copy, selection.method = "vst", verbose = FALSE)

so_decon_norm_copy <- ScaleData(so_decon_norm_copy,features = rownames(so_decon_norm_copy), verbose = FALSE)
```

```{r}
so_decon_norm_copy <- RunPCA(object = so_decon_norm_copy, features = rownames(so_decon_norm_copy), verbose = FALSE)
```


```{r fig.height=14, fig.width=14}
# Generate the plot with enhancements
no_feature_defined_non_subseted_decon <- DimPlot(so_decon_norm_copy, reduction = "pca", group.by = "stage") +
    ggtitle("Deconvolution Normalized + Not Subsetted + Explicit Feature Definition (all genes) - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "H", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(no_feature_defined_non_subseted_decon)
```


```{r}
so_decon_norm_subset <- subset(so_decon_norm, features = mSEG)

so_decon_norm_subset <- RunPCA(so_decon_norm_subset,features = mSEG, npcs = 30, verbose = FALSE)

```



```{r, fig.height=14, fig.width=14}
# Generate the plot with enhancements
no_feature_defined_subseted_decon <- DimPlot(so_decon_norm_subset, reduction = "pca", group.by = "stage") +
    ggtitle("Deconvolution Normalized + Subsetted + Explicit Feature Definition (mSEG) - GSE121708") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "H", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(no_feature_defined_subseted_decon)
```

















































































