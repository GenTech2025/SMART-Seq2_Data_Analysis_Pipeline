---
title: "targets-file-creation"
author: "S2599932"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Get metadata information from GEO

```{r}
library(ggplot2)
library(GEOquery)
library(tidyverse)
```

```{r}
geo_id <- "GSE75748"
gset <- getGEO(geo_id, GSEMatrix = TRUE)
```

```{r}
# Extract the phenotype data (metadata)
phenoData <- pData(phenoData(gset[[1]]))

colnames(phenoData)
```
## Visualize the distribution of different cell types indifferent datasets
### GSE71318
```{r}
cell_counts <- data.frame(table(phenoData$source_name_ch1))

# Plot the bar plot
GSE71318_cell_type <- ggplot(cell_counts, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  theme_classic(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 7),
    axis.title = element_text(face = "bold", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.grid.major = element_line(color = "grey", size = 0.2),
    panel.grid.minor = element_line(color = "grey", size = 0.1),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  ) +
  labs(x = "Cell Type", y = "Counts", title = "GSE71318")

# Save the plot in high quality
ggsave("classic_cell_type_GSE71318.png", plot = GSE71318_cell_type, width = 10, height = 8, dpi = 300)
```
### GSE36552
```{r}
cell_counts <- data.frame(table(phenoData$'cell type:ch1'))

# Plot the bar plot
GSE36552_cell_type <- ggplot(cell_counts, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  theme_classic(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 7),
    axis.title = element_text(face = "bold", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.grid.major = element_line(color = "grey", size = 0.2),
    panel.grid.minor = element_line(color = "grey", size = 0.1),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  ) +
  labs(x = "Cell Type", y = "Counts", title = "GSE36552")

# Save the plot in high quality
ggsave("classic_cell_type_GSE36552.png", plot = GSE36552_cell_type, width = 10, height = 8, dpi = 300)
```

### GSE75748
```{r fig.height=6, fig.width=8}
cell_counts <- data.frame(table(phenoData$source_name_ch1))

# Plot the bar plot
GSE75748_cell_type <- ggplot(cell_counts, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  theme_classic(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 7),
    axis.title = element_text(face = "bold", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.grid.major = element_line(color = "grey", size = 0.2),
    panel.grid.minor = element_line(color = "grey", size = 0.1),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  ) +
  labs(x = "Cell Type", y = "Counts", title = "GSE75748")

print(GSE75748_cell_type)

# Save the plot in high quality
# ggsave("classic_cell_type_GSE75748.png", plot = GSE75748_cell_type, width = 10, height = 8, dpi = 300)
```

### E-MTAB-3929
```{r}
# Read in the targets file for EMTAB3929
emtab3929 <- read.csv("../../../study-datasets/E-MTAB-3929_self_processed/E-MTAB-3929_targets.csv", header = TRUE)

cell_counts <- data.frame(table(emtab3929$development_stage))

# Plot the bar plot
emtab3929_cell_type <- ggplot(cell_counts, aes(x = reorder(Var1, Freq), y = Freq)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  theme_classic(base_size = 15) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 7),
    axis.title = element_text(face = "bold", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 12),
    panel.grid.major = element_line(color = "grey", size = 0.2),
    panel.grid.minor = element_line(color = "grey", size = 0.1),
    plot.margin = margin(t = 20, r = 20, b = 20, l = 20)
  ) +
  labs(x = "Cell Type", y = "Counts", title = "E-MTAB-3929")

# Save the plot in high quality
ggsave("classic_cell_type_EMTAB3929.png", plot = emtab3929_cell_type, width = 10, height = 8, dpi = 300)
```

### Four panel plot for all the datasets
```{r}
four_panel_plot <- plot_grid(GSE71318_cell_type, GSE36552_cell_type, GSE75748_cell_type, emtab3929_cell_type, labels = "AUTO", ncol = 2, nrow = 2)

ggsave("combined_datasets_cell_count.png", plot = four_panel_plot, width = 14, height = 16, dpi = 300)
```


```{r}
targets <- data.frame(
  Sample_ID = phenoData$geo_accession,
  Sample_Name = phenoData$title,  # Adjust this if the sample names are under a different column
  Cell_Type = phenoData$`cell type:ch1`,
  Developmental_Stage = phenoData$`developmental stage:ch1`,
  Tissue = phenoData$`tissue:ch1`
)
```

```{r}
original_colnames <- colnames(t1_cleaned)

# Use gsub to extract the sample accessions
new_colnames <- gsub(".*(SRR[0-9]+).*", "\\1", original_colnames)

# Assign the new column names to the dataframe
colnames(t1_cleaned) <- new_colnames
```

```{r}
gsmID <- targets$Sample_ID
writeLines(gsmID, "./gsm_ids.txt")
```





## Create a new dataframe containing desired metadata information
```{r}
targets <- data.frame(
  geo_accession = phenoData$geo_accession,
  cell_type = phenoData$source_name_ch1,
  description = phenoData$description.2,
  passage_no = phenoData$`passage:ch1`
)
```


```{r}
# Read the contents of the TSV file
file_path <- './GSMtoSRR/geo_accession.tsv'
tsv_data <- read.table(file_path, sep = '\t', header = FALSE, stringsAsFactors = FALSE)

# Extract the GSM IDs
gsm_ids <- tsv_data$V1

# Convert the GSM IDs to a bash array format
gsm_ids_bash_array <- paste0("gsm_ids=(", paste(gsm_ids, collapse = " "), ")")

# Output the bash array
cat(gsm_ids_bash_array)
```


### Save the geo accession IDs to a file
```{r}
# writeLines(as.character(targets$geo_accession), "./GSMtoSRR/GSE75748_geo_ID.txt")

write.table(phenoData$geo_accession, "geo_accession.tsv", sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)
```



## MAPPING THE GSM IDs to SRR IDs
### USING SRA TOOLKIT AND EDIRECT - needs to be downloaded on server
> Having some trouble trying to read out from .txt file, so for now we can just hard code the input

##### For GSE36552
```{bash}
# for GSE36552
#!/bin/bash

# Function to get SRR ID from GSM ID
get_srr_id() {
    local gsm_id=$1
    esearch -db sra -query $gsm_id | efetch -format runinfo | grep $gsm_id
}

# List of hardcoded GSM IDs
gsm_ids=(
    "GSM896803" "GSM896804" "GSM896805" "GSM896806" "GSM896807" "GSM896808"
    "GSM896809" "GSM896810" "GSM896811" "GSM896812" "GSM896813" "GSM896814"
    "GSM896815" "GSM896816" "GSM922146" "GSM922147" "GSM922148" "GSM922149"
    "GSM922150" "GSM922151" "GSM922152" "GSM922153" "GSM922154" "GSM922155"
    "GSM922156" "GSM922157" "GSM922158" "GSM922159" "GSM922160" "GSM922161"
    "GSM922162" "GSM922163" "GSM922164" "GSM922165" "GSM922166" "GSM922167"
    "GSM922168" "GSM922169" "GSM922170" "GSM922171" "GSM922172" "GSM922173"
    "GSM922174" "GSM922175" "GSM922176" "GSM922177" "GSM922178" "GSM922179"
    "GSM922180" "GSM922181" "GSM922182" "GSM922183" "GSM922184" "GSM922185"
    "GSM922186" "GSM922187" "GSM922188" "GSM922189" "GSM922190" "GSM922191"
    "GSM922192" "GSM922193" "GSM922194" "GSM922195" "GSM922196" "GSM922197"
    "GSM922198" "GSM922199" "GSM922200" "GSM922201" "GSM922202" "GSM922203"
    "GSM922204" "GSM922205" "GSM922206" "GSM922207" "GSM922208" "GSM922209"
    "GSM922210" "GSM922211" "GSM922212" "GSM922213" "GSM922214" "GSM922215"
    "GSM922216" "GSM922217" "GSM922218" "GSM922219" "GSM922220" "GSM922221"
    "GSM922222" "GSM922223" "GSM922224" "GSM922225" "GSM922226" "GSM922227"
    "GSM922228" "GSM922230" "GSM922250" "GSM922251" "GSM922252" "GSM922253"
    "GSM922254" "GSM922255" "GSM922256" "GSM922257" "GSM922258" "GSM922259"
    "GSM922260" "GSM922261" "GSM922262" "GSM922263" "GSM922264" "GSM922265"
    "GSM922266" "GSM922267" "GSM922268" "GSM922269" "GSM922270" "GSM922271"
    "GSM922272" "GSM922273" "GSM922274" "GSM922275"
)

# Create a CSV file to store the mappings
output_file="gsm_to_srr_mapping.csv"
echo "GSM_ID,SRR_ID" > $output_file

# Log file for errors
error_log="GSE36552_gsm_to_srr_errors.log"
echo "Errors:" > $error_log

# Loop through each hardcoded GSM ID and get the corresponding SRR ID
for gsm_id in "${gsm_ids[@]}"; do
    if [[ -z "$gsm_id" ]]; then
        continue
    fi
    srr_info=$(get_srr_id $gsm_id)
    if [[ -n "$srr_info" ]]; then
        srr_id=$(echo "$srr_info" | cut -d ',' -f 1)
        echo "$gsm_id,$srr_id" >> $output_file
    else
        echo "$gsm_id,NA" >> $output_file
        echo "Failed to map $gsm_id" >> $error_log
    fi
done

echo "Mapping completed. Check the file $output_file for the results and $error_log for any errors."

```

##### For GSE71318
```{bash}
#!/bin/bash

# Function to get SRR ID from GSM ID
get_srr_id() {
    local gsm_id=$1
    esearch -db sra -query $gsm_id | efetch -format runinfo | grep $gsm_id
}

# List of hardcoded GSM IDs
gsm_ids=("GSM1833279" "GSM1833280" "GSM1833281" "GSM1833282" "GSM1833283" "GSM1833284" "GSM1833285" "GSM1833286"
         "GSM1833287" "GSM1833288" "GSM1833289" "GSM1833290" "GSM1833291" "GSM1833292" "GSM1833294" "GSM1833295"
         "GSM1833296" "GSM1833297" "GSM1833298" "GSM1833300" "GSM1833302" "GSM1833304" "GSM1833307" "GSM1833309"
         "GSM1833312" "GSM1833314" "GSM1833316" "GSM1833318" "GSM1833321" "GSM1833323" "GSM1833324" "GSM1833325"
         "GSM1833326" "GSM1833327" "GSM1833328" "GSM1833329" "GSM1833330" "GSM1833331" "GSM1833332" "GSM1833333"
         "GSM1833334" "GSM1985628" "GSM1985629" "GSM1985630" "GSM1985631" "GSM2151860" "GSM2151861" "GSM2151862")

# Create a CSV file to store the mappings
output_file="GSE71318_gsm_to_srr_mapping.csv"
echo "GSM_ID,SRR_ID" > $output_file

# Log file for errors
error_log="gsm_to_srr_errors.log"
echo "Errors:" > $error_log

# Loop through each hardcoded GSM ID and get the corresponding SRR ID
for gsm_id in "${gsm_ids[@]}"; do
    if [[ -z "$gsm_id" ]]; then
        continue
    fi
    srr_info=$(get_srr_id $gsm_id)
    if [[ -n "$srr_info" ]]; then
        srr_id=$(echo "$srr_info" | cut -d ',' -f 1)
        echo "$gsm_id,$srr_id" >> $output_file
    else
        echo "$gsm_id,NA" >> $output_file
        echo "Failed to map $gsm_id" >> $error_log
    fi
done

echo "Mapping completed. Check the file $output_file for the results and $error_log for any errors."
```



##### For GSE75748 (did no use this code chunk)
```{bash}
#!/bin/bash

# Function to get SRR ID from GSM ID
get_srr_id() {
    local gsm_id=$1
    esearch -db sra -query $gsm_id | efetch -format runinfo | grep $gsm_id
}

# File containing GSM IDs
gsm_id_file="gsm_ids.txt"

# Create a CSV file to store the mappings
output_file="GSE75748_gsm_to_srr_mapping.csv"
echo "GSM_ID,SRR_ID" > $output_file

# Log file for errors
error_log="gsm_to_srr_errors.log"
echo "Errors:" > $error_log

# Loop through each GSM ID in the file and get the corresponding SRR ID
while IFS= read -r gsm_id; do
    if [[ -z "$gsm_id" ]]; then
        continue
    fi
    srr_info=$(get_srr_id $gsm_id)
    if [[ -n "$srr_info" ]]; then
        srr_id=$(echo "$srr_info" | cut -d ',' -f 1)
        echo "$gsm_id,$srr_id" >> $output_file
    else
        echo "$gsm_id,NA" >> $output_file
        echo "Failed to map $gsm_id" >> $error_log
    fi
done < "$gsm_id_file"

echo "Mapping completed. Check the file $output_file for the results and $error_log for any errors."

```


#### Add this mapping to the final targets file
```{r}
# Check if file exists
file_path <- "/home/s2599932/MSc_DSB_Dissertation_2024/03-raw-data-pre-processing/metadata-creation/GSMtoSRR/GSE75748_gsm_to_srr_mapping.csv"
if (file.exists(file_path)) {
  mapping <- read.csv(file_path, header = TRUE)
} else {
  stop("File does not exist at the specified path.")
}

colnames(mapping) <- c("geo_accession","run_accession")

targets <- targets %>%
  left_join(mapping, by = "geo_accession")

# Save the targets file as CSV
write.csv(targets, file = "./GSE75748_targets.csv",row.names = FALSE)
```

