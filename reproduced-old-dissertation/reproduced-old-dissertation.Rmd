---
title: "reproduced-old-dissertation"
author: "B243232"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

# Reproduced analysis for the last years dissertation with some improvements and modifications

## Initial quality control and SingleCellExperiment object creation

```{r load_libraries, message=FALSE, warning=FALSE}
library(Seurat)
library(scMerge)
library(SingleCellExperiment)
library(ggplot2)
library(dplyr)
library(biomaRt)
library(corrplot)
library(scater)
library(scran)

library(biomaRt)
library(dplyr)
library(knitr)
```



```{r define_functions, message=FALSE, warning=FALSE}
coefficient_of_variation <- function(x){
  cv <- sd(x)/mean(x)
  return (cv)
}
```



```{r read_data, message=FALSE, warning=FALSE}
es_targets <- read.table("/home/s2599932/mouse-dataset/E-MTAB-2600/E-MTAB-2600.targets.txt", sep = "\t", header = TRUE, row.names = "ERR") # Metadata

es_raw <- readRDS("/home/s2599932/mouse-dataset/E-MTAB-2600/single_es_tximport.rds") # Counts data
```



```{r load_mSEGs, message=FALSE, warning=FALSE}
data("segList_ensemblGeneID", package = "scMerge")
mSEG <- segList_ensemblGeneID$mouse$mouse_scSEG # Extracting SEGs identified in mouse by scRNA Seq
```



```{r singlecellexperiment_object_creation, message=FALSE, warning=FALSE}
es_sce <- SingleCellExperiment(assays=list(counts = es_raw$counts, abundance = es_raw$abundance))
```



```{r calculating_qc_metrics, message=FALSE, warning=FALSE}
is_spike <- grepl("^ERCC",rownames(es_sce))
mitogenes <- "ENSMUSG00000064336|ENSMUSG00000064337|ENSMUSG00000064338|ENSMUSG00000064339|ENSMUSG00000064340|ENSMUSG00000064341|ENSMUSG00000064342|ENSMUSG00000064343|ENSMUSG00000064344|ENSMUSG00000064345|ENSMUSG00000064346|ENSMUSG00000064347|ENSMUSG00000064348|ENSMUSG00000064349|ENSMUSG00000064350|ENSMUSG00000064351|ENSMUSG00000064352|ENSMUSG00000064353|ENSMUSG00000064354|ENSMUSG00000064355|ENSMUSG00000064356|ENSMUSG00000064357|ENSMUSG00000064358|ENSMUSG00000064359|ENSMUSG00000064360|ENSMUSG00000064361|ENSMUSG00000065947|ENSMUSG00000064363|ENSMUSG00000064364|ENSMUSG00000064365|ENSMUSG00000064366|ENSMUSG00000064367|ENSMUSG00000064368|ENSMUSG00000064369|ENSMUSG00000064370|ENSMUSG00000064371|ENSMUSG00000064372"
is_mito <- grepl(mitogenes, rownames(es_sce))

es_sce$qc_stats <- perCellQCMetrics(es_sce, subsets=list(ERCC=is_spike, Mt=is_mito))
```



```{r basic_quality_control_plots, message=FALSE, warning=FALSE}
# Library sizes in millions
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/quality-control/library_sizes.tiff", width=7, height=7, units="in", res=300)
hist(es_sce$qc_stats$sum/1e6, 
     xlab="Library sizes (millions)", 
     main="Histogram of Library Sizes", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
dev.off()

print(hist(es_sce$qc_stats$sum/1e6, 
     xlab="Library sizes (millions)", 
     main="Histogram of Library Sizes", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells"))

# Number of detected genes
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/quality-control/detected_genes.tiff", width=7, height=7, units="in", res=300)
hist(es_sce$qc_stats$detected, 
     xlab="Number of detected genes", 
     main="Histogram of Detected Genes", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
dev.off()

print(hist(es_sce$qc_stats$detected, 
     xlab="Number of detected genes", 
     main="Histogram of Detected Genes", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells"))

# Mitochondrial gene proportion (%)
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/quality-control/mitochondial_proportion.tiff", width=7, height=7, units="in", res=300)
hist(es_sce$qc_stats$subsets_Mt_percent,
     xlab="Mitochondrial proportion (%)", 
     main="Histogram of Mitochondrial Proportion", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
dev.off()

print(hist(es_sce$qc_stats$subsets_Mt_percent,
     xlab="Mitochondrial proportion (%)", 
     main="Histogram of Mitochondrial Proportion", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells"))

# ERCC proportion (%)
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/quality-control/ERCC_proportion.tiff", width=7, height=7, units="in", res=300)
hist(es_sce$qc_stats$subsets_ERCC_percent,
     xlab="ERCC proportion (%)", 
     main="Histogram of ERCC Proportion", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells")
dev.off()

print(hist(es_sce$qc_stats$subsets_ERCC_percent,
     xlab="ERCC proportion (%)", 
     main="Histogram of ERCC Proportion", 
     breaks=20, 
     col="grey80", 
     ylab="Number of cells"))

```



```{r filtering_singlecellexperiment_object_based_on_qc, message=FALSE, warning=FALSE}
# Calculating the filtering metrics
libsize_drop <- isOutlier(es_sce$qc_stats$sum, nmads = 3, type = "lower", log = TRUE)
feature_drop <- isOutlier(es_sce$qc_stats$detected, nmads = 3, type = "lower", log = TRUE)
mito_drop <- isOutlier(es_sce$qc_stats$subsets_Mt_percent, nmads = 3, type = "higher")
spike_drop <- isOutlier(es_sce$qc_stats$subsets_ERCC_percent, nmads = 3, type = "higher")
 
es_sce_copy <- es_sce # Save a non filtered copy

# Filtering the SingleCellExperiment(SCE) object
es_sce_fil <- es_sce[,!(libsize_drop|feature_drop|mito_drop|spike_drop)]
es_sce_fil_copy <- es_sce_fil # Save a filtered copy

# Save the filtered cells
filtered_cells <- colnames(es_sce_fil)
```

> **Out of 869 initial number of cells, 515 cells remain after filtering**


### Creating the seurat object and carrying out downstream analysis using seurat until clustering

```{r creating_seurat_object, message=FALSE, warning=FALSE}
es_counts <- as.data.frame(es_raw$counts)

# Creating the seurat object(so)
so_raw <- CreateSeuratObject(counts = es_counts)
so_raw <- AddMetaData(so_raw, metadata = es_targets)
```

```{r copying_raw_seurat_object, message=FALSE, warning=FALSE}
# Save a copy of the raw seurat object
so_raw_copy <- so_raw
```

```{r subset_SO_to_include_only_cells_that_passed_qc, message=FALSE, warning=FALSE}
so_raw_fil <- so_raw[,filtered_cells]
so_raw_fil_copy <- so_raw_fil
```

```{r normalize_and_find_variable_features, message=FALSE, warning=FALSE}
so_norm_fil <- NormalizeData(so_raw_fil, verbose = FALSE)
so_norm_fil <- ScaleData(so_norm_fil, verbose = FALSE)
so_norm_fil <- FindVariableFeatures(so_norm_fil, selection.method = "vst", verbose = FALSE)
```


### PCA with all genes as features with no explicit feature defination

```{r copying_normalized_seurat_object, message=FALSE, warning=FALSE}
so_norm_fil_non_subseted <- so_norm_fil # this object will be used for PCA using all genes as features
```


```{r pca_using_seurat_object_containing_all_genes_no_explicit_feature_defination, message=FALSE, warning=FALSE}
so_norm_fil_non_subseted <- RunPCA(so_norm_fil_non_subseted, verbose = FALSE) # PCA using all genes as features with no explicit feature definition
```


```{r fig.height= 14, fig.width= 14}
# Generate the plot with enhancements
no_feature_defined_non_subseted <- DimPlot(so_norm_fil_non_subseted, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Not Subsetted + No Explicit Feature Definition") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size

# Print the plot
print(no_feature_defined_non_subseted)
```


```{r}
so_non_subseted_load <- Loadings(so_norm_fil_non_subseted)
```

> Identify and annotate the cell outliers in the no_feature_defined_non_subsetedPCA plot

```{r label_the_outlying_points, fig.height=14, fig.width=14}
# Extract PCA embeddings to identify outliers
pca_embeddings <- Embeddings(so_norm_fil_non_subseted, reduction = "pca")

# Manually identify outliers based on PCA coordinates (you can adjust the criteria as needed)
# For example, let's consider cells with PC_1 > 40 as outliers
outliers <- rownames(pca_embeddings[pca_embeddings[, 1] > 10, ])

# Generate the plot with enhancements and label outliers
no_feature_defined_non_subseted <- DimPlot(so_norm_fil_non_subseted, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Not Subsetted + No Explicit Feature Definition") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size

# Add labels to outliers
no_feature_defined_non_subseted <- LabelPoints(plot = no_feature_defined_non_subseted, points = outliers, repel = TRUE)

# Print the plot
print(no_feature_defined_non_subseted)
```


### PCA of non subseted seurat object with explicit feature defination (all genes as features)


```{r copying_normalized_seurat_object, message=FALSE, warning=FALSE}
so_norm_fil_non_subseted_features <- so_norm_fil
```


```{r pca_using_seurat_object_containing_all_genes_explicit_feature_defination, message=FALSE, warning=FALSE}
so_norm_fil_non_subseted_features <- RunPCA(so_norm_fil_non_subseted_features, features = rownames(so_norm_fil_non_subseted_features), verbose = FALSE) # PCA using all genes as features with explicit feature definition
```


```{r fig.height= 14, fig.width= 14}
# Generate the plot with enhancements
feature_defined_non_subseted <- DimPlot(so_norm_fil_non_subseted_features, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Not Subsetted + Explicit Feature Definition (all genes)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

# Print the plot
print(feature_defined_non_subseted)
```


```{r}
so_non_subseted_feature_load <- Loadings(so_norm_fil_non_subseted)
so_non_subseted_feature_embeddings <- Embeddings(so_norm_fil_non_subseted)
```


```{r fig.height=14, fig.width=14}
# Generate the second PCA plot with the same outliers labeled
feature_defined_non_subseted <- DimPlot(so_norm_fil_non_subseted_features, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Not Subsetted + Explicit Feature Definition (all genes)") +
    theme_minimal(base_size = 15) +
    scale_color_viridis_d(option = "D", end = 0.9) +
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 12)
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))

feature_defined_non_subseted <- LabelPoints(plot = feature_defined_non_subseted, points = outliers, repel = TRUE)

print(feature_defined_non_subseted)
```



### PCA with non-subseted seurat object with explicit feature defination (mSEGs as features)


```{r}
so_norm_fil_non_subseted_seg <- so_norm_fil
```

```{r, warning=FALSE, message=FALSE}
so_norm_fil_non_subseted_seg <- RunPCA(so_norm_fil_non_subseted_seg,features = mSEG, verbose = FALSE)
```

```{r fig.height=14, fig.width=14}
# Generate the plot with enhancements
seg_feature_defined_non_subseted <- DimPlot(so_norm_fil_non_subseted_seg, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Not Subsetted + Explicit Feature Definition (mSEGs)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size

seg_feature_defined_non_subseted <- LabelPoints(plot = seg_feature_defined_non_subseted, points = outliers, repel = TRUE)
# Print the plot
print(seg_feature_defined_non_subseted)
```



### PCA with subseted seurat object (subseted by mSEGs) with explicit feature defination (mSEGs as features)

```{r}
so_norm_fil_subseted_seg <- subset(so_norm_fil, features = mSEG)
```

```{r, warning=FALSE, message=FALSE}
so_norm_fil_subseted_seg <- RunPCA(so_norm_fil_subseted_seg,features = mSEG, verbose = FALSE)
```

```{r fig.height=14, fig.width=14}
# Generate the plot with enhancements
seg_feature_defined_subseted <- DimPlot(so_norm_fil_subseted_seg, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Subsetted (by mSEGs) + Explicit Feature Definition (mSEGs)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size

seg_feature_defined_subseted <- LabelPoints(plot = seg_feature_defined_subseted, points = outliers, repel = TRUE)

# Print the plot
print(seg_feature_defined_subseted)
```


### PCA with subseted seurat object (subseted by mSEGs) with no explicit feature defination

```{r}
so_norm_fil_subseted <- subset(so_norm_fil,features = mSEG)
```

```{r, warning=FALSE, message=FALSE}
so_norm_fil_subseted <- RunPCA(so_norm_fil_subseted, verbose = FALSE)
```

```{r fig.height=14, fig.width=14}
# Generate the plot with enhancements
feature_not_defined_subseted <- DimPlot(so_norm_fil_subseted, reduction = "pca", group.by = "Type") +
    ggtitle("Seurat Normalized + Subsetted (by mSEGs) + No Explicit Feature Definition") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_viridis_d(option = "D", end = 0.9) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size

feature_not_defined_subseted <- LabelPoints(plot = feature_not_defined_subseted, points = outliers, repel = TRUE)

# Print the plot
print(feature_not_defined_subseted)
```

```{r}
feature_not_defined_subseted_load <- Loadings(so_norm_fil_subseted)
feature_not_defined_subseted_embed <- Embeddings(so_norm_fil_subseted)
```



### Now the pipeline diverges into two branche - 1) Using seurat normalization and 2) Using deconvolution normalization.

### Dimensionality reduction using PCA for seurat normalized data

```{r PCA_for_seurat_normalized_data_features_not_defined, message=FALSE, warning=FALSE}
# Making a copy of seurat object
so_norm_fil_copy <- so_norm_fil
# PCA
so_norm_fil <- RunPCA(object = so_norm_fil, features = rownames(so_norm_fil), verbose = FALSE)
# Subset the SO by mSEGs
so_norm_fil_seg <- subset(so_norm_fil, features = mSEG)
# Run Second PCA
so_norm_fil_seg <- RunPCA(object = so_norm_fil_seg, verbose = FALSE)

# Plot the results
p1 <- DimPlot(so_norm_fil, reduction = "pca", group.by = "Type") +
      ggtitle("All genes as features") +
      theme_minimal() +
      scale_color_viridis_d()

p2 <- DimPlot(so_norm_fil_seg, reduction = "pca", group.by = "Type") +
      ggtitle("mSEGs as features") +
      theme_minimal() +
      scale_color_viridis_d()

pca_compare <- cowplot::plot_grid(p1, p2, ncol = 2, align = 'v', 
                                  labels = c("A", "B"),  
                                  label_size = 14)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/seurat-normalization/seurat_normalized_PCA_features_not_defined.tiff", width = 12, height = 8, units = "in", res = 300)
print(pca_compare)
dev.off()

```

```{r fig.width=12, fig.height=8}
print(pca_compare)
```

#### Extract the PCA loadings and subset and annotate the resulting dataframe

```{r extract_pca_loadings_seurat_normalized, message=FALSE, warning=FALSE}
# Extracting the PCA loading for second PCA
pca_seg_load <- Loadings(object = so_norm_fil_seg, reduction = "pca")
pca_seg_load_df <- as.data.frame(pca_seg_load)
pca_seg_load_df$ensemblID <- rownames(pca_seg_load_df) # add ensemblID column


# Map the ensemblIDs to gene names using biomaRt
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
ensembl_ids <- pca_seg_load_df$ensemblID

gene_mapping <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name"),
  filters = "ensembl_gene_id",
  values = ensembl_ids,
  mart = ensembl
)
# Rename the columns for consistency
colnames(gene_mapping) <- c("ensemblID", "gene_name")
# Merge the PCA loadings data frame with the gene mapping
an_seg_pca_seurat <- merge(pca_seg_load_df, gene_mapping, by = "ensemblID", all.x = TRUE)


# Sort and subset the loading data frame
sorted_an_seurat_seg <- an_seg_pca_seurat %>% arrange(desc(PC_1))
sorted_an_seurat_seg <- sorted_an_seurat_seg %>% dplyr::select(ensemblID,gene_name,PC_1,PC_2,PC_3,PC_4,PC_5)

# Write out as csv file
write.csv(sorted_an_seurat_seg, file = "/home/s2599932/dissertation-main/output-files/reproduced-old-dissertation/pca-loadings/seurat_normalized_features_not_defined_PCA_ranked.csv", row.names = FALSE)
```

```{r message=FALSE, warning=FALSE}
# Show the table in kintted document using knitr package
kable(sorted_an_seurat_seg)
```



### Dimensionality reduction UMAP and t-SNE for seurat normalized data

#### UMAP

```{r UMAP_for_seurat_normalized_data, message=FALSE, warning=FALSE}
so_norm_fil <- RunUMAP(so_norm_fil, dims = 1:20, verbose = FALSE)
so_norm_fil_seg <- RunUMAP(so_norm_fil_seg, dims = 1:20, verbose = FALSE)

# Plot the results
p1_umap <- DimPlot(so_norm_fil, reduction = "umap", group.by = "Type") +
           ggtitle("All genes as features") +
           theme_minimal() +
           scale_color_viridis_d()

p2_umap <- DimPlot(so_norm_fil_seg, reduction = "umap", group.by = "Type") +
           ggtitle("mSEGs as features") +
           theme_minimal() +
           scale_color_viridis_d()

umap_compare <- cowplot::plot_grid(p1_umap, p2_umap, ncol = 2, align = 'v',
                                   labels = c("A", "B"),
                                   label_size = 14)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/seurat-normalization/seurat_UMAP_compare.tiff", width = 12, height = 8, units = "in", res = 300)
print(umap_compare)
dev.off()
```

```{r fig.width=12, fig.height=8}
print(umap_compare)
```

#### t-SNE

```{r t-SNE_for_seurat_normalized_data, message=FALSE, warning=FALSE}
so_norm_fil <- RunTSNE(so_norm_fil, dims = 1:20, verbose = FALSE)
so_norm_fil_seg <- RunTSNE(so_norm_fil_seg, dims = 1:20, verbose = FALSE)

# Plot the results
p1_tsne <- DimPlot(so_norm_fil, reduction = "tsne", group.by = "Type") +
           ggtitle("All genes as features") +
           theme_minimal() +
           scale_color_viridis_d()

p2_tsne <- DimPlot(so_norm_fil_seg, reduction = "tsne", group.by = "Type") +
           ggtitle("mSEGs as features") +
           theme_minimal() +
           scale_color_viridis_d()

tsne_compare <- cowplot::plot_grid(p1_tsne, p2_tsne, ncol = 2, align = 'v',
                                   labels = c("A", "B"),
                                   label_size = 14)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/seurat-normalization/seurat_tSNE_compare.tiff", width = 12, height = 8, units = "in", res = 300)
print(tsne_compare)
dev.off()
```

```{r fig.width=12, fig.height=8}
print(tsne_compare)
```



### Dimensionality reduction using PCA for deconvolution normalized data

```{r deconvolution_normalization, message=FALSE, warning=FALSE}
clusters <- quickCluster(es_sce_fil_copy)
es_sce_fil_copy <- computeSumFactors(es_sce_fil_copy, clusters = clusters)
es_sce_fil_copy <- logNormCounts(es_sce_fil_copy)
```



```{r creating_seurat_object_from_deconvolution_normalized_data, message=FALSE, warning=FALSE}
# Extract the normalized data from SCE object
normalized_counts <- assay(es_sce_fil_copy, "logcounts")

# Create the seurat object 
so_decon_norm <- CreateSeuratObject(counts = normalized_counts)
so_decon_norm <- AddMetaData(so_decon_norm, metadata = es_targets)

# Add the normalized data to seurat object
DefaultAssay(so_decon_norm) <- "RNA"
so_decon_norm <- SetAssayData(so_decon_norm, slot = "data", new.data = normalized_counts)
```



```{r subset_scale_and_find_variable_features, message=FALSE, warning=FALSE}
so_decon_norm <- so_decon_norm[,filtered_cells] # Only include cells that passed QC

# Make a copy
so_decon_norm_copy <- so_decon_norm

# Scale and find variable features
so_decon_norm <- ScaleData(so_decon_norm, verbose = FALSE)
so_decon_norm <- FindVariableFeatures(so_decon_norm, selection.method = "vst", verbose = FALSE)
```



```{r PCA_on_deconvolution_normalized data, message=FALSE, warning=FALSE}
# First PCA
so_decon_norm <- RunPCA(object = so_decon_norm, features = rownames(so_decon_norm), verbose = FALSE)

# Second PCA
so_decon_norm_seg <- subset(so_decon_norm, features = mSEG)
so_decon_norm_seg <- RunPCA(so_decon_norm_seg, verbose = FALSE)

# Plot the results

de_p1 <- DimPlot(so_decon_norm, reduction = "pca", group.by = "Type") +
      ggtitle("All genes as features") +
      theme_minimal() +
      scale_color_viridis_d()

de_p2 <- DimPlot(so_decon_norm_seg, reduction = "pca", group.by = "Type") +
      ggtitle("mSEGs as features") +
      theme_minimal() +
      scale_color_viridis_d()


de_pca_compare <- cowplot::plot_grid(de_p1, de_p2, ncol = 2, align = 'v', 
                                  labels = c("A", "B"), 
                                  label_size = 14)


tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/deconvolution-normalization/deconv_pca_compare.tiff", width = 12, height = 8, units = "in", res = 300)
print(de_pca_compare)
dev.off()
```

```{r fig.width=12, fig.height=8}
print(de_pca_compare)
```


```{r extract_pca_loadings_deconvolution_normalized_data_pca, message=FALSE, warning=FALSE}
# Extracting the PCA loading for second PCA
decon_pca_load <- Loadings(object = so_decon_norm_seg, reduction = "pca")
decon_pca_load_df <- as.data.frame(decon_pca_load)
decon_pca_load_df$ensemblID <- rownames(decon_pca_load_df) # add ensemblID column


# Map the ensemblIDs to gene names using biomaRt
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
ensembl_ids <- decon_pca_load_df$ensemblID

gene_mapping <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name"),
  filters = "ensembl_gene_id",
  values = ensembl_ids,
  mart = ensembl
)
# Rename the columns for consistency
colnames(gene_mapping) <- c("ensemblID", "gene_name")
# Merge the PCA loadings data frame with the gene mapping
an_seg_pca_decon <- merge(decon_pca_load_df, gene_mapping, by = "ensemblID", all.x = TRUE)


# Sort and subset the loading data frame
sorted_an_decon_seg <- an_seg_pca_decon %>% arrange(desc(PC_1))
sorted_an_decon_seg <- sorted_an_decon_seg %>% dplyr::select(ensemblID,gene_name,PC_1,PC_2,PC_3,PC_4,PC_5)

# Write out as csv file
write.csv(sorted_an_decon_seg, file = "/home/s2599932/dissertation-main/output-files/reproduced-old-dissertation/pca-loadings/deconvolution_normalized_features_not_defined_PCA_ranked.csv", row.names = FALSE)
```


```{r}
kable(sorted_an_decon_seg)
```


### Dimensionality reduction using UMAP and t-SNE for deconvolution normalized data

#### UMAP

```{r UMAP_for_deconvolution_normalized_data, message=FALSE, warning=FALSE}
so_decon_norm <- RunUMAP(so_decon_norm, dims = 1:7, verbose = FALSE) # needs to be changed to 1:8 
so_decon_norm_seg <- RunUMAP(so_decon_norm_seg, dims = 1:7, verbose = FALSE) # needs to be changed to 1:8 earlier the pca reduced to 8 dimensions but now its reducing to 7

# Plot the results
de_p1_umap <- DimPlot(so_decon_norm, reduction = "umap", group.by = "Type") +
           ggtitle("All genes as features") +
           theme_minimal() +
           scale_color_viridis_d()

de_p2_umap <- DimPlot(so_decon_norm_seg, reduction = "umap", group.by = "Type") +
           ggtitle("mSEGs as features") +
           theme_minimal() +
           scale_color_viridis_d()

de_umap_compare <- cowplot::plot_grid(de_p1_umap, de_p2_umap, ncol = 2, align = 'v',
                                   labels = c("A", "B"),
                                   label_size = 14)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/deconvolution-normalization/deconv_umap_compare.tiff", width = 12, height = 8, units = "in", res = 300)
print(de_umap_compare)
dev.off()
```


```{r fig.width=12, fig.height=8}
print(de_umap_compare)
```

#### t-SNE

```{r tSNE_for_deconvolution_normalized_data, message=FALSE, warning=FALSE}
so_decon_norm <- RunTSNE(so_decon_norm, dims = 1:8)
so_decon_norm_seg <- RunTSNE(so_decon_norm_seg, dims = 1:8)

# Plot the results
de_p1_tsne <- DimPlot(so_decon_norm, reduction = "tsne", group.by = "Type") +
           ggtitle("All genes as features") +
           theme_minimal() +
           scale_color_viridis_d()

de_p2_tsne <- DimPlot(so_decon_norm_seg, reduction = "tsne", group.by = "Type") +
           ggtitle("mSEGs as features") +
           theme_minimal() +
           scale_color_viridis_d()

de_tsne_compare <- cowplot::plot_grid(de_p1_tsne, de_p2_tsne, ncol = 2, align = 'v',
                                   labels = c("A", "B"),
                                   label_size = 14)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/dimesionality-reduction-plots/deconvolution-normalization/deconv_tsne_compare.tiff", width = 12, height = 8, units = "in", res = 300)
print(de_tsne_compare)
dev.off()
```


```{r fig.width=12, fig.height=8}
print(de_tsne_compare)
```






### Coefficient of variation comparision of SEGs and nonSEGs using seurat normalization

```{r initial_setting_up, message=FALSE, warning=FALSE}
so_raw_copy <- so_raw

# Normalize the data using seurat function
so_raw_copy <- NormalizeData(so_raw_copy, verbose = FALSE)
so_raw_copy <- ScaleData(so_raw_copy, verbose = FALSE)

so_raw_copy <- FindVariableFeatures(so_raw_copy, selection.method = "vst", verbose = FALSE)

variable_gene <- VariableFeatures(so_raw_copy)

so_seg_all <- subset(so_raw_copy, features = mSEG)
# Subset the seurat objects by cell type
so_raw_copy_serum <- subset(so_seg_all, Type == "serum")
so_raw_copy_2i <- subset(so_seg_all, Type == "2i")
so_raw_copy_a2i <- subset(so_seg_all, Type == "a2i")

```



```{r CV_comparision_between_SEG_nonSEG, message=FALSE, warning=FALSE}
# Compute CV for SEGs
so_seg_cv <- apply(as.matrix(GetAssayData(so_seg_all, layer = "data", assay = "RNA")),1,coefficient_of_variation)

# Determine remaining genes and reference genes
remaining_genes <- setdiff(rownames(so_raw_copy), mSEG)
reference_genes <- sample(remaining_genes, size = 722)

# Extract expression data for reference genes
reference_expr <- as.data.frame(GetAssayData(so_raw_copy, layer = "data", assay = "RNA"))
reference_expr <- reference_expr[reference_genes, ]

# Compute CV for nonSEGs
so_nonseg_cv <- apply(as.matrix(reference_expr), 1, coefficient_of_variation)

# Prepare and Plot the data
seg_plot <- data.frame(Gene = rownames(so_seg_all), CV = so_seg_cv)
nonseg_plot <- data.frame(Gene = rownames(reference_expr), CV = so_nonseg_cv)

cv_p1 <- ggplot(seg_plot, aes(x = Gene, y = CV)) +
  geom_point() +
  labs(title = "CV of SEG genes") +
  theme(axis.text.x = element_blank(), legend.position = "none") +
  ylim(0, 30)

cv_p2 <- ggplot(nonseg_plot, aes(x = Gene, y = CV)) +
  geom_point() +
  labs(title = "CV of other genes") +
  theme(axis.text.x = element_blank(), legend.position = "none") +
  ylim(0, 30)

cv_compare <- cowplot::plot_grid(cv_p1, cv_p2, ncol = 2)

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/cv_compare_plot.tiff", width = 12, height = 8, units = "in", res = 300)
print(cv_compare)
dev.off()
```


```{r fig.width=12, fig.height=8}
print(cv_compare)
```




### Coefficient of variation comparision of SEGs and nonSEGs using seurat normalization

- need to do


### PCA and Clustering using the non filtered seurat object

```{r PCA_seurat_normalized_data_non_filtered, message=FALSE, warning=FALSE}
so_seg_all <- RunPCA(so_seg_all, assay = "RNA", verbose = FALSE)
pca_embedding <- as.data.frame(Embeddings(so_seg_all, reduction = "pca"))

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/PCA_all_cells.tiff", width = 12, height = 8, units = "in", res = 300)
DimPlot(so_seg_all, reduction = "pca", group.by = "Type") +
  ggtitle("PCA for all cells (feature = SEG)")
dev.off()

```


```{r fig.width=12, fig.height=8}
print(DimPlot(so_seg_all, reduction = "pca", group.by = "Type") +
  ggtitle("PCA for all cells (feature = SEG)"))
```



```{r}
so_seg_all$seurat_clusters <- ifelse(
  pca_embedding$PC_1 > -6 & pca_embedding$PC_1 <=4, "cluster0", ifelse(pca_embedding$PC_1 > 4, "cluster1", "cluster2")
)

# set active identity class to new clusters
Idents(so_seg_all) <- factor(so_seg_all$seurat_clusters)

# PLot clusters for all cells with vertical lines
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/Cluster_all_cells.tiff", width = 12, height = 8, units = "in", res = 300)
DimPlot(so_seg_all, reduction = "pca", group.by = "seurat_clusters") +
  ggtitle("Cluster for all cells") +
  geom_vline(xintercept = 4, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = -6, linetype = "dashed", color = "blue")
dev.off()
```


```{r fig.width=12, fig.height=8}
print(DimPlot(so_seg_all, reduction = "pca", group.by = "seurat_clusters") +
  ggtitle("Cluster for all cells") +
  geom_vline(xintercept = 4, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = -6, linetype = "dashed", color = "blue"))
```

## The previous years dissertation has been reproduced up until this point since rest of the files that have been read in the script after this point are missing.

**Points to Notice**
- The plot for "cluster for all cell" only shows presence of two clusters, maybe an error on my part.
- The downstream analysis after dimensionality reduction has only been covered using the seurat pipeline and SingleCellExperiment pipeline of this part has not been created yet.



```{r nono_expression_across_different_cells, fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
# Subset the Seurat object to include only the desired cell types
selected_cell_types <- subset(so_raw_copy, subset = Type %in% c("2i", "a2i", "serum"))

# Create the violin plot for the selected cell types with enhanced aesthetics
p <- VlnPlot(selected_cell_types, features = "ENSMUSG00000031311", group.by = "Type", 
             pt.size = 0.1) +
    ggtitle("Expression of Nono Across Different Cell Types") +
    theme_minimal(base_size = 15) +
    labs(y = "Expression Level", x = "Cell Type") +
    theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.title.x = element_text(face = "bold"),
        axis.title.y = element_text(face = "bold"),
        legend.position = "right",
        panel.grid.major = element_line(color = "grey80")
    ) +
    scale_fill_manual(values = c("2i" = "#E69F00", "a2i" = "#56B4E9", "serum" = "#009E73"))

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/violin_plot_nono_expression.tiff", width = 12, height = 8, units = "in", res = 300)
print(p)
dev.off()
```

```{r}
print(p)
```


Let's interpret the violin plot step by step:

### Title and Axes

1. **Title**: "Expression of Nono Across different Cell Types"
   - This tells us that the plot is showing the expression levels of the gene Nono in different cell types.

2. **Y-axis**: "Expression Level"
   - The y-axis represents the level of gene expression. Higher values indicate higher expression levels.

3. **X-axis**: "Cell Type"
   - The x-axis represents different cell types: "2i", "a2i", and "serum".

### Violin Plots

Each violin plot represents the distribution of Nono gene expression levels within each cell type.

1. **2i (Red)**
   - The distribution is wide and mostly concentrated between expression levels 1 and 3.
   - The shape indicates that most cells have expression levels around 2, with fewer cells at the extremes (near 0 and 3).

2. **a2i (Green)**
   - The distribution is narrower compared to the 2i cell type.
   - It shows a peak around an expression level of 1, suggesting that most cells have lower expression levels.
   - There are still some cells with higher expression levels, but these are less common.

3. **Serum (Blue)**
   - This distribution is similar in width to the 2i cell type but with more concentration towards lower expression levels.
   - The expression levels are spread out between 0 and 3, with a higher density around levels 1 and 2.

### Interpretation

1. **Comparison of Expression Levels Across Cell Types**:
   - The 2i cell type has a broader distribution of Nono expression levels, suggesting more variability within this cell type.
   - The a2i cell type shows lower and more consistent expression levels, indicating less variability.
   - The serum cell type has a moderate spread with a slight skew towards lower expression levels compared to the 2i cell type.

2. **Density and Distribution**:
   - The density of points inside each violin indicates the concentration of cells at specific expression levels. 
   - In the 2i and serum cell types, the expression levels are more spread out, whereas in the a2i cell type, they are more tightly grouped.

### Summary

- **2i cells** have a broad range of Nono expression, indicating high variability.
- **a2i cells** tend to have lower and more uniform Nono expression.
- **Serum cells** show moderate variability with a tendency towards lower expression levels compared to 2i cells.

This visualization effectively demonstrates the differences in Nono gene expression across these three cell types, highlighting both the central tendency and the spread of expression levels within each cell type.




```{r nono_dot_plot}
tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/nono_dot_plot.tiff", width = 12, height = 8, units = "in", res = 300)
DotPlot(selected_cell_types, features = "ENSMUSG00000031311", group.by = "Type") +
    ggtitle("Dot Plot of ENSMUSG00000031311 Across Selected Cell Types") +
    theme_minimal() +
    labs(y = "Cell Type", x = "Expression Level")
dev.off()
```



```{r fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
# Ensure that only the specific cell types are included
selected_cell_types <- subset(so_raw_copy, subset = Type %in% c("2i", "a2i", "serum"))

# Extract the expression data for the gene of interest and the cell type information
gene_expression_data <- FetchData(selected_cell_types, vars = c("ENSMUSG00000031311", "Type"))

# Filter out any unwanted cell types explicitly (if necessary)
gene_expression_data <- gene_expression_data[gene_expression_data$Type %in% c("2i", "a2i", "serum"), ]

# Create a box plot with enhanced aesthetics
b0 <- ggplot(gene_expression_data, aes(x = Type, y = ENSMUSG00000031311, fill = Type)) +
        geom_boxplot(outlier.color = "black", outlier.shape = 16, outlier.size = 2, notch = FALSE) +
        stat_summary(fun.y = mean, geom = "point", shape = 20, size = 3, color = "white", fill = "white") +
        scale_fill_manual(values = c("2i" = "#E69F00", "a2i" = "#56B4E9", "serum" = "#009E73")) +
        labs(title = "Expression of Nono Across Cell Types",
             x = "Cell Type",
             y = "Expression Level",
             fill = "Cell Type") +
        theme_minimal(base_size = 15) +
        theme(
            plot.title = element_text(hjust = 0.5, face = "bold"),
            axis.title.x = element_text(face = "bold"),
            axis.title.y = element_text(face = "bold"),
            legend.position = "right"
        ) +
        theme(panel.grid.major = element_line(color = "grey80"))

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/nono_box_plot.tiff", width = 12, height = 8, units = "in", res = 300)
print(b0)
dev.off()
```

```{r}
print(b0)
```


```{r fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
# Create the enhanced box plot
b1 <-  ggplot(gene_expression_data, aes(x = Type, y = ENSMUSG00000031311, fill = Type)) +
      geom_violin(trim = FALSE, alpha = 0.6, color = "black") + # Add violin plot for density representation
      geom_boxplot(width = 0.1, outlier.color = "black", outlier.shape = 16, outlier.size = 1.5, notch = FALSE, color = "black", alpha = 0.7) + # Overlay box plot
      stat_summary(fun = mean, geom = "point", shape = 20, size = 3, color = "red", fill = "white") + # Add mean points
      scale_fill_manual(values = c("2i" = "#E69F00", "a2i" = "#56B4E9", "serum" = "#009E73")) + # Custom colors
      labs(
          title = "Expression of Nono Across Cell Types",
          x = "Cell Type",
          y = "Expression Level",
          fill = "Cell Type"
      ) +
      theme_minimal(base_size = 15) +
      theme(
          plot.title = element_text(hjust = 0.5, face = "bold"),
          axis.title.x = element_text(face = "bold"),
          axis.title.y = element_text(face = "bold"),
          legend.position = "right",
          panel.grid.major = element_line(color = "grey80")
      ) +
      theme(
          axis.text.x = element_text(angle = 45, hjust = 1) # Rotate x-axis labels for better readability
      )

tiff("/home/s2599932/dissertation-main/plots/reproduced-old-dissertation/additional-plots/nono_box_violin_plot.tiff", width = 12, height = 8, units = "in", res = 300)
print(b1)
dev.off()
```



```{r fig.height=8, fig.width=12, message=FALSE, warning=FALSE}
print(b1)
```




