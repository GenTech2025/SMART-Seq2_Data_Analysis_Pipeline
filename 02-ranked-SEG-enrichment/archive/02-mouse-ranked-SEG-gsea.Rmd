---
title: "ranked-SEG-compare-study"
author: "S2599932"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = FALSE)
```

## Using SEG ranking between two datasets  to find biological meaning

---

### Define File Paths
```{r}
dataset_one_dir <- "/home/s2599932/study-datasets/mouse-dataset/E-MTAB-2600/single_es_tximport.rds" # E-MTAB-2600
dataset_two_dir <- "/home/s2599932/study-datasets/mouse-dataset/GSE121708/counts.txt" # GSE121708
dataset_one_annotation_dir <- "/home/s2599932/study-datasets/mouse-dataset/E-MTAB-2600/E-MTAB-2600.targets.txt"
dataset_two_annotation_dir <- "/home/s2599932/study-datasets/mouse-dataset/GSE121708/sample_metadata.txt"
```

### Load Libraries
```{r}
library(Seurat)
library(scMerge)
library(SingleCellExperiment)
library(tidyverse)
library(biomaRt)
library(scater)
library(scran)
library(fgsea)
library(msigdb)
library(GSEABase)
library(jsonlite)
```

---
### Nomenclature
- **raw_one from this point refers to E-MTAB-2600 which is mouse embryonic stem cell data set**
- **raw_two from this point refers to GSE121708 which is mouse early development data set**
---

### Load the datasets and annotation file
```{r}
# Read the data sets
raw_one <- readRDS(dataset_one_dir)

# E-MTAB-2600 annotation
annotation_one <- read.table(dataset_one_annotation_dir, sep = "\t", header = TRUE, row.names = "ERR")
annotation_one <- annotation_one[match(colnames(raw_one$counts), rownames(annotation_one)), ]

# Read the data sets
raw_two <- read.table(dataset_two_dir, header = TRUE, row.names = 1)

 # GSE121708 annotation
annotation_two <- read.table(dataset_two_annotation_dir, sep = "\t", header = TRUE)
annotation_two <- annotation_two[,c("id_rna","sample","stage","plate","embryo","lineage10x")]
rownames(annotation_two) <- annotation_two$id_rna
annotation_two <- annotation_two[match(colnames(raw_two), rownames(annotation_two)), ]

raw_two <- raw_two[,annotation_two$id_rna]
```

### Creating the single cell experiment object
```{r}
 sce_one <- SingleCellExperiment(
  assays = list(counts = as.matrix(raw_one$counts)),
  colData = annotation_one
)

sce_two <- SingleCellExperiment(
  assays = list(counts = as.matrix(raw_two)),
  colData = annotation_two
)
```

### Initial Quality Control

---

#### QC for first dataset
```{r dataset_one}
is_spike_one <- grepl("^ERCC",rownames(sce_one))
mitogenes <- "ENSMUSG00000064336|ENSMUSG00000064337|ENSMUSG00000064338|ENSMUSG00000064339|ENSMUSG00000064340|ENSMUSG00000064341|ENSMUSG00000064342|ENSMUSG00000064343|ENSMUSG00000064344|ENSMUSG00000064345|ENSMUSG00000064346|ENSMUSG00000064347|ENSMUSG00000064348|ENSMUSG00000064349|ENSMUSG00000064350|ENSMUSG00000064351|ENSMUSG00000064352|ENSMUSG00000064353|ENSMUSG00000064354|ENSMUSG00000064355|ENSMUSG00000064356|ENSMUSG00000064357|ENSMUSG00000064358|ENSMUSG00000064359|ENSMUSG00000064360|ENSMUSG00000064361|ENSMUSG00000065947|ENSMUSG00000064363|ENSMUSG00000064364|ENSMUSG00000064365|ENSMUSG00000064366|ENSMUSG00000064367|ENSMUSG00000064368|ENSMUSG00000064369|ENSMUSG00000064370|ENSMUSG00000064371|ENSMUSG00000064372"
is_mito_one <- grepl(mitogenes, rownames(sce_one))
sce_one$qc_stats <- perCellQCMetrics(sce_one, subsets=list(ERCC=is_spike_one, Mt=is_mito_one))

# Calculate the QC metrics based on which cells will be retained or eliminated
libsize_drop_one <- isOutlier(sce_one$qc_stats$sum, nmads = 3, type = "lower", log = TRUE)
feature_drop_one <- isOutlier(sce_one$qc_stats$detected, nmads = 3, type = "lower", log = TRUE)
mito_drop_one <- isOutlier(sce_one$qc_stats$subsets_Mt_percent, nmads = 3, type = "higher")
spike_drop_one <- isOutlier(sce_one$qc_stats$subsets_ERCC_percent, nmads = 3, type = "higher")

# Save a copy of the unfiltered SCE object
sce_one_copy <- sce_one

# Drop the samples from the SCE object that does not meet the QC standards
sce_one_fil <- sce_one[, !(libsize_drop_one | feature_drop_one | mito_drop_one | spike_drop_one)]
filtered_cells_one <- colnames(sce_one_fil)
```

---

#### QC for second dataset
```{r dataset_two}
is_spike_two <- grepl("^ERCC",rownames(sce_two))
mitogenes <- "ENSMUSG00000064336|ENSMUSG00000064337|ENSMUSG00000064338|ENSMUSG00000064339|ENSMUSG00000064340|ENSMUSG00000064341|ENSMUSG00000064342|ENSMUSG00000064343|ENSMUSG00000064344|ENSMUSG00000064345|ENSMUSG00000064346|ENSMUSG00000064347|ENSMUSG00000064348|ENSMUSG00000064349|ENSMUSG00000064350|ENSMUSG00000064351|ENSMUSG00000064352|ENSMUSG00000064353|ENSMUSG00000064354|ENSMUSG00000064355|ENSMUSG00000064356|ENSMUSG00000064357|ENSMUSG00000064358|ENSMUSG00000064359|ENSMUSG00000064360|ENSMUSG00000064361|ENSMUSG00000065947|ENSMUSG00000064363|ENSMUSG00000064364|ENSMUSG00000064365|ENSMUSG00000064366|ENSMUSG00000064367|ENSMUSG00000064368|ENSMUSG00000064369|ENSMUSG00000064370|ENSMUSG00000064371|ENSMUSG00000064372"
is_mito_two <- grepl(mitogenes, rownames(sce_two))
sce_two$qc_stats <- perCellQCMetrics(sce_two, subsets=list(ERCC=is_spike_two, Mt=is_mito_two))

# Calculate the QC metrics based on which cells will be retained or eliminated
libsize_drop_two <- isOutlier(sce_two$qc_stats$sum, nmads = 3, type = "lower", log = TRUE)
feature_drop_two <- isOutlier(sce_two$qc_stats$detected, nmads = 3, type = "lower", log = TRUE)
mito_drop_two <- isOutlier(sce_two$qc_stats$subsets_Mt_percent, nmads = 3, type = "higher")
spike_drop_two <- isOutlier(sce_two$qc_stats$subsets_ERCC_percent, nmads = 3, type = "higher")

# Save a copy of the unfiltered SCE object
sce_two_copy <- sce_two

# Drop the samples from the SCE object that does not meet the QC standards
sce_two_fil <- sce_two[, !(libsize_drop_two | feature_drop_two | mito_drop_two | spike_drop_two)]
filtered_cells_two <- colnames(sce_two_fil)
```

> Point to Note: The second dataset doesnt have some ERCC spike ins and Mitochondrial genes

---

### Normalization (Deconvolution normalization using scran)

```{r}
# For first data set
clusters_one <- quickCluster(sce_one_fil)
sce_one_fil <- computeSumFactors(sce_one_fil, clusters = clusters_one)
sce_one_fil <- logNormCounts(sce_one_fil)

# For second data set
clusters_two <- quickCluster(sce_two_fil)
sce_two_fil <- computeSumFactors(sce_two_fil, clusters = clusters_two)
sce_two_fil <- logNormCounts(sce_two_fil)
```

> 30-07-24

#### Identify stably expressed genes in both the datasets/cell types
```{r}
# Copy the SCE object to a new variable name
sce_one <- sce_one_fil
sce_two <- sce_two_fil
```

```{r}
sum(is.na(rowSums(logcounts(sce_one))))
sum(is.na(colSums(logcounts(sce_one))))

sum(is.na(rowSums(logcounts(sce_two))))
sum(is.na(colSums(logcounts(sce_two))))
```

```{r}
# Order the row names
sce_one <- sce_one[order(rownames(sce_one), decreasing = FALSE), ]
sce_two <- sce_two[order(rownames(sce_two), decreasing = FALSE), ]

# Identify the stably expressed genes
sce_one_seg <- scSEGIndex(exprs(sce_one),cell_type = colData(sce_one)$Type,return_all = TRUE)
sce_two_seg <- scSEGIndex(exprs(sce_two),cell_type = colData(sce_two)$stage,return_all = TRUE)

# Save a copy
one_seg <- sce_one_seg
two_seg <- sce_two_seg
```



```{r REVOKED}
# Arrange in descending order and select the first 1000 rows
sce_one_seg <- sce_one_seg %>%
  arrange(desc(segIdx)) %>%
  slice(1:1000) # Change made on 31-07-24

sce_two_seg <- sce_two_seg %>%
  arrange(desc(segIdx)) %>%
  slice(1:1000) # Change made on 31-07-24
```

> Remember the lower the sgIdx value the higher the stability of the genes (not the other way aroung as i thought)

#### Find the top 1000 stable genes in the two datasets
```{r}
# Arrange in ascending order and select the first 1000 rows # Changed on 31-07-24
sce_one_seg_1000 <- sce_one_seg %>%
  arrange(segIdx)%>%
  slice(1:1000)

sce_two_seg_1000 <- sce_two_seg %>%
  arrange(segIdx)%>%
  slice(1:1000)

# Extract the most stable gene names from the two data sets
first_1000_genes <- rownames(as.data.frame(sce_one_seg_1000))
second_1000_genes <- rownames(as.data.frame(sce_two_seg_1000))

# Find the common genes between the two data sets
final_stable_gene_list <- union(first_1000_genes, second_1000_genes)
unique_genes <- Filter(function(x) length(grep(x, final_stable_gene_list)) == 1, final_stable_gene_list)
```

#### Extract the stability index scores for those cumilative top stable genes
```{r}
# Create data frame from the results of scSEGIndex() 
sce_one_seg_df <- as.data.frame(sce_one_seg)
sce_two_seg_df <- as.data.frame(sce_two_seg)

# Only retain the rows corresponding to the most stable genes
sce_one_seg_df <- sce_one_seg_df[unique_genes,]
sce_two_seg_df <- sce_two_seg_df[unique_genes,]

# Rename the segIdx columns
sce_one_seg_df <- sce_one_seg_df %>% rename(segIdx_one = segIdx)
sce_two_seg_df <- sce_two_seg_df %>% rename(segIdx_two = segIdx)

# Arrange the data frame in ascending order of segIdx values
sce_one_seg_df <- sce_one_seg_df %>%
  arrange(segIdx_one)

sce_two_seg_df <- sce_two_seg_df %>%
  arrange(segIdx_two)

# Cross add the segIdx columns to the data frames
sce_one_seg_df$segIdx_two <- sce_two_seg_df[rownames(sce_one_seg_df), "segIdx_two"]
sce_two_seg_df$segIdx_one <- sce_one_seg_df[rownames(sce_two_seg_df), "segIdx_one"]

# Compute the differences between the segIdx columns
sce_one_seg_df$segIdx_one_vs_two <- sce_one_seg_df$segIdx_one - sce_one_seg_df$segIdx_two
sce_two_seg_df$segIdx_two_vs_one <- sce_two_seg_df$segIdx_two - sce_two_seg_df$segIdx_one

#sce_one_seg_df <- sce_one_seg_df %>%
  #mutate(segIdx_one_vs_two = segIdx_one - segIdx_two)

#sce_two_seg_df <- sce_two_seg_df %>%
  #mutate(segIdx_two_vs_one = segIdx_two - segIdx_one)

# Store the columns with NA values (NA values arose due to high percentage of zero number)
na_rows_one <- sce_one_seg_df %>%
  filter(is.na(segIdx_one_vs_two)) %>%
  rownames()

na_rows_two <- sce_two_seg_df %>%
  filter(is.na(segIdx_two_vs_one)) %>%
  rownames()
```

#### Remove NA values from the segIdx difference columns
```{r}
# Remove rows with NA values in the segIdx column
sce_one_seg_df <- sce_one_seg_df %>%
  filter(!is.na(segIdx_one_vs_two))

sce_two_seg_df <- sce_two_seg_df %>%
  filter(!is.na(segIdx_two_vs_one))

# Rename the data frames
sce_one_df <- sce_one_seg_df
sce_two_df <- sce_two_seg_df
```


#### Compute the rank difference in stablity between two data sets
```{r}
# Filter the data frames to only contains rows with sgIdx value of less than 0.5
sce_one_seg <- sce_one_seg %>%
  filter(segIdx < 0.5)

sce_two_seg <- sce_two_seg %>%
  filter(segIdx < 0.5)


# compute the rank difference
sce_one_seg$segIdx_one <- rank(-1 * sce_one_seg$segIdx, ties.method = "average")
sce_two_seg$segIdx_two <- rank(-1 * sce_two_seg$segIdx, ties.method = "average")

sce_one_seg$segIdx_two <- sce_two_seg[rownames(sce_one_seg),]$segIdx_two
sce_two_seg$segIdx_one <- sce_one_seg[rownames(sce_two_seg),]$segIdx_one

sce_one_seg$segIdx_one_vs_two <- sce_one_seg$segIdx_one - sce_one_seg$segIdx_two
sce_two_seg$segIdx_two_vs_one <- sce_two_seg$segIdx_two - sce_two_seg$segIdx_one

sce_one_seg <- sce_one_seg %>% 
  arrange(desc(segIdx))
sce_two_seg <- sce_two_seg %>% 
  arrange(desc(segIdx))

sce_one_df <- as.data.frame(sce_one_seg)
sce_two_df <- as.data.frame(sce_two_seg)
```

#### Map the ensembl IDs to entrez ID, external gene name and Gene biotype
##### Map the first dataset
```{r}
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
attributes_mouse <- listAttributes(ensembl)

# write.csv(attributes_mouse,file = "./mouse_ensembl_atributes.csv", row.names = FALSE)

# Map the ensembl IDs of the first dataset
ensembl_id_one <- sce_one_df$gene

# Get the mapping information
mapping_info_one <- getBM(
    attributes = c(
        "ensembl_gene_id",
        "external_gene_name",
        "gene_biotype",
        "description"
    ),
    filters = "ensembl_gene_id",
    values = ensembl_id_one,
    mart = ensembl
)

map_df_one <- as.data.frame(mapping_info_one)
```

```{r fig.height=6, fig.width=8}
# Create a bar plot with customized title and axis labels
one_gb <- ggplot(map_df_one, aes(x = gene_biotype)) +
          geom_bar(fill = "steelblue") +
          theme_classic() +
          labs(
              title = "Count of Genes by Gene Biotype : Dataset One",
              x = "Gene Biotype",
              y = "Count"
          ) +
          theme(
              plot.title = element_text(size = 15, face = "bold", hjust = 0.5),  # Customize title size, font, and position
              axis.title.x = element_text(size = 10, face = "bold", hjust = 0.5, vjust = -0.5),  # Customize x-axis label
              axis.title.y = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1.5),  # Customize y-axis label
              axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  # Customize x-axis text
              axis.text.y = element_text(size = 10)  # Customize y-axis text
          )

print(one_gb)
```

##### Map the second dataset
```{r}
ensembl <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
attributes_mouse <- listAttributes(ensembl)

# write.csv(attributes_mouse,file = "./mouse_ensembl_atributes.csv", row.names = FALSE)

# Map the ensembl IDs of the first dataset
ensembl_id_two <- sce_two_df$gene

# Get the mapping information
mapping_info_two <- getBM(
    attributes = c(
        "ensembl_gene_id",
        "external_gene_name",
        "gene_biotype",
        "description"
    ),
    filters = "ensembl_gene_id",
    values = ensembl_id_two,
    mart = ensembl
)

map_df_two <- as.data.frame(mapping_info_two)
```

```{r fig.height=6, fig.width=8}
# Create a bar plot with customized title and axis labels
two_gb <- ggplot(map_df_two, aes(x = gene_biotype)) +
          geom_bar(fill = "steelblue") +
          theme_classic() +
          labs(
              title = "Count of Genes by Gene Biotype : Dataset Two",
              x = "Gene Biotype",
              y = "Count"
          ) +
          theme(
              plot.title = element_text(size = 15, face = "bold", hjust = 0.5),  # Customize title size, font, and position
              axis.title.x = element_text(size = 10, face = "bold", hjust = 0.5, vjust = -0.5),  # Customize x-axis label
              axis.title.y = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1.5),  # Customize y-axis label
              axis.text.x = element_text(angle = 45, hjust = 1, size = 12),  # Customize x-axis text
              axis.text.y = element_text(size = 10)  # Customize y-axis text
          )

print(two_gb)
```

```{r fig.height=6, fig.width=16}
library(cowplot)

gene_type_plot_combined <- plot_grid(one_gb, two_gb, ncol = 2)

print(gene_type_plot_combined)
```





#### Now add the external gene names to the SEG dataframe
```{r}
# Create new data frame containing the mapping of ensembl IDs to external gene name
ensb_to_name_one <- data.frame(
  gene = map_df_one$ensembl_gene_id,
  external_gene_name = map_df_one$external_gene_name
)

ensb_to_name_two <- data.frame(
  gene = map_df_two$ensembl_gene_id,
  external_gene_symbol = map_df_two$external_gene_name
)

# Join the data frames using an inner join
sce_one_df <- inner_join(sce_one_df, ensb_to_name_one, by = c("gene" = "gene"))
sce_two_df <- inner_join(sce_two_df, ensb_to_name_two, by = c("gene" = "gene"))
```

#### Remove any rows with NA values in the difference column (Not Required)
```{r}
sce_one_df <- sce_one_df %>%
    filter(!is.na(.data[["segIdx_one_vs_two"]]) & .data[["segIdx_one_vs_two"]] != "")

sce_two_df <- sce_two_df %>%
    filter(!is.na(.data[["segIdx_two_vs_one"]]) & .data[["segIdx_two_vs_one"]] != "")
```

#### Create the named vector for GSEA
```{r}
top_1000_df_one <- sce_one_df %>%
  arrange(segIdx) %>%
  slice(1:1000)

top_1000_df_two <- sce_two_df %>%
  arrange(segIdx) %>%
  slice(1:1000)

# Create named vector list
sce_one_ordered1000_lst <- setNames(top_1000_df_one$segIdx_one_vs_two, top_1000_df_one$external_gene_name)
sce_two_ordered1000_lst <- setNames(top_1000_df_two$segIdx_two_vs_one, top_1000_df_two$external_gene_symbol)
```

#### Updated named list
> 01-08-24

```{r}
sce_one_ordered1000_lst <- setNames(sce_one_df$segIdx_one_vs_two, sce_one_df$external_gene_name)
sce_two_ordered1000_lst <- setNames(sce_two_df$segIdx_two_vs_one, sce_two_df$external_gene_symbol)
```

#### Retrieve all gene list for mouse
```{r}
# Retrieve the MSigDB for Mus musculus using gene symbols (version 7.5.1)
msigdb.mm = getMsigdb(org = 'mm', id = 'SYM', version = '7.5.1')
msigdb.mm = appendKEGG(msigdb.mm)
msigdb.mm.list <- geneIds(msigdb.mm)
```

#### GSEA using fgsea
```{r}
# for the first subset
fgsea_one <- fgsea(pathways = msigdb.mm.list, stats = sce_one_ordered1000_lst, minSize =5, maxSize = 100, nPermSimple = 100000)
fgsea_one <- fgsea_one %>%
  arrange(padj, desc(abs(NES)))

# for the second subset
fgsea_two <- fgsea(pathways = msigdb.mm.list, stats = sce_two_ordered1000_lst,minSize =5, maxSize = 100, nPermSimple = 100000)
fgsea_two <- fgsea_two %>%
  arrange(padj, desc(abs(NES)))
```

#### Save the results
```{r}
# Function to convert list columns to JSON strings
convert_list_columns_to_json <- function(df) {
  list_columns <- sapply(df, is.list)
  df[list_columns] <- lapply(df[list_columns], function(col) {
    sapply(col, jsonlite::toJSON, auto_unbox = TRUE)
  })
  return(df)
}

# Convert the list to data frame
fgsea_one <- convert_list_columns_to_json(as.data.frame(fgsea_one))
fgsea_two <- convert_list_columns_to_json(as.data.frame(fgsea_two))
#hallmark_fgsea_one <- convert_list_columns_to_json(as.data.frame(hallmark_fgsea_one))
#hallmark_fgsea_two <- convert_list_columns_to_json(as.data.frame(hallmark_fgsea_two))

# Save as csv files
write.csv(fgsea_one, file = "./EMTAB2600_vs_GSE121708_fgsea_all_pathways.csv", row.names = FALSE)
write.csv(fgsea_two, file = "./GSE121708_vs_EMTAB2600_fgsea_all_pathways.csv", row.names = FALSE)
#write.csv(hallmark_fgsea_one, file = "/home/s2599932/MSc_DSB_Dissertation_2024/02-ranked-SEG-enrichment/E-MTAB-3929/hallmark_fgsea_one.csv", row.names = FALSE)
#write.csv(hallmark_fgsea_two, file = "/home/s2599932/MSc_DSB_Dissertation_2024/02-ranked-SEG-enrichment/E-MTAB-3929/hallmark_fgsea_two.csv", row.names = FALSE)
```