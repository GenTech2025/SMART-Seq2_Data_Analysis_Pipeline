---
title: "Bioconductor-workflow-mouse"
author: "S2599932"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
header-includes:
  - \usepackage{fontspec}
  - \setmainfont{Liberation Sans}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

# This pipeline contains the complete seurat workflow and should be used to generate the PCA plots mentioned below
 1) **Deconvolution normalized + non subsetted + no features defined**
 2) **Deconvolution normalized + non subsetted + all genes as features**
 3) **Deconvolution normalized + non subsetted + mSEGs as features**
 4) **Deconvolution normalized + subsetted + no features defined**
 5) **Deconvolution normalized + subsetted + mSEGs as features**
 
---
 
### Defination of some of the terminologies used

- **Deconvolution normalized**: 
- **Non-subsetted**: A Seurat object which contains all the rownames (i.e., ensembl IDs) obtained from the counts matrix from which this object was created.
- **Subsetted**: A Seurat object which contains only rownames that correspond to the mSEG list. This object was created using the **subset()** function with the features to use set as the mSEG list.
- **No features defined**: While using Seurat's **RunPCA()** function, the *features* parameter was not used to explicitly define the features.
- **Features defined**: While using Seurat's **RunPCA()** function, the *features* parameter was used to explicitly define features (i.e., either all genes or mSEG list).


---

#### Define filepaths paths

```{r}
data_directory <- "/home/s2599932/study-datasets/mouse-dataset/E-MTAB-2600/single_es_tximport.rds"
annotation_directory <- "/home/s2599932/study-datasets/mouse-dataset/E-MTAB-2600/E-MTAB-2600.targets.txt"
output_files_directory <- "./"
output_plots_directory <- "./"
```

#### Load libraries

```{r load_libraries, message=FALSE, warning=FALSE}
library(Seurat)
library(scMerge)
library(SingleCellExperiment)
library(ggplot2)
library(dplyr)
library(biomaRt)
library(corrplot)
library(scater)
library(scran)

library(biomaRt)
library(dplyr)
library(knitr)
```

#### Load in data and annotation file

```{r}
annotation <- read.table(annotation_directory, sep = "\t", header = TRUE, row.names = "ERR")
raw_data <- readRDS(data_directory)
```


```{r load_mSEGs, message=FALSE, warning=FALSE}
data("segList_ensemblGeneID", package = "scMerge")
mSEG <- segList_ensemblGeneID$mouse$mouse_scSEG # Extracting SEGs identified in mouse by scRNA Seq
```

#### Create SCE object

```{r}
sce_raw <- SingleCellExperiment(assays=list(counts = raw_data$counts, abundance = raw_data$abundance))
```

#### Quality control on the SCE object

```{r}
is_spike <- grepl("^ERCC", rownames(sce_raw))
mitogenes <- "ENSMUSG00000064336|ENSMUSG00000064337|ENSMUSG00000064338|ENSMUSG00000064339|ENSMUSG00000064340|ENSMUSG00000064341|ENSMUSG00000064342|ENSMUSG00000064343|ENSMUSG00000064344|ENSMUSG00000064345|ENSMUSG00000064346|ENSMUSG00000064347|ENSMUSG00000064348|ENSMUSG00000064349|ENSMUSG00000064350|ENSMUSG00000064351|ENSMUSG00000064352|ENSMUSG00000064353|ENSMUSG00000064354|ENSMUSG00000064355|ENSMUSG00000064356|ENSMUSG00000064357|ENSMUSG00000064358|ENSMUSG00000064359|ENSMUSG00000064360|ENSMUSG00000064361|ENSMUSG00000065947|ENSMUSG00000064363|ENSMUSG00000064364|ENSMUSG00000064365|ENSMUSG00000064366|ENSMUSG00000064367|ENSMUSG00000064368|ENSMUSG00000064369|ENSMUSG00000064370|ENSMUSG00000064371|ENSMUSG00000064372"
is_mito <- grepl(mitogenes, rownames(sce_raw))

sce_raw$qc_stats <- perCellQCMetrics(sce_raw, subsets=list(ERCC=is_spike, Mt=is_mito))
```

> QC histograms have not been plotted

```{r}
# Calculating the filtering metrics
libsize_drop <- isOutlier(sce_raw$qc_stats$sum, nmads = 3, type = "lower", log = TRUE)
feature_drop <- isOutlier(sce_raw$qc_stats$detected, nmads = 3, type = "lower", log = TRUE)
mito_drop <- isOutlier(sce_raw$qc_stats$subsets_Mt_percent, nmads = 3, type = "higher")
spike_drop <- isOutlier(sce_raw$qc_stats$subsets_ERCC_percent, nmads = 3, type = "higher")

sce_raw_copy <- sce_raw # Save a non-filtered copy

# Filtering the SingleCellExperiment (SCE) object
sce_raw_fil <- sce_raw[, !(libsize_drop | feature_drop | mito_drop | spike_drop)]
sce_raw_fil_copy <- sce_raw_fil # Save a filtered copy

# Save the filtered cells
filtered_cells <- colnames(sce_raw_fil)
```


### Deconvolution Normalization and Downstream Analysis using seurat

```{r deconvolution_normalization, message=FALSE, warning=FALSE}
clusters <- quickCluster(sce_raw_fil_copy)
sce_raw_fil_copy <- computeSumFactors(sce_raw_fil_copy, clusters = clusters)
sce_raw_fil_copy <- logNormCounts(sce_raw_fil_copy)
```

#### Downstream seurat worflow

```{r}
normalized_counts <- assay(sce_raw_fil_copy, "logcounts")

so_norm <- CreateSeuratObject(counts = normalized_counts)
so_norm <- AddMetaData(so_norm, metadata = annotation)
so_norm_copy <- so_norm

# Add the normalized data to seurat object
DefaultAssay(so_norm) <- "RNA"
so_norm <- SetAssayData(so_norm, slot = "data", new.data = normalized_counts)
```


```{r}
# Only include samples that passed QC
so_norm_fil <- so_norm[,filtered_cells]
so_norm_fil_copy <- so_norm_fil
```


```{r}
so_norm_fil <- FindVariableFeatures(so_norm_fil, selection.method = "vst", verbose = FALSE)

so_norm_fil <- ScaleData(so_norm_fil,features = rownames(so_norm_fil), verbose = FALSE)
```

---

#### Now since we need to create five PCA plots, we are going to copy **so_norm_fil** to five different objects in order to avoid any confusion. 
- non_subsetted_no_features_defined
- non_subsetted_all_genes_as_features
- non_subsetted_mSEGs_as_features
- subsetted_no_features_defined
- subsetted_mSEGs_as_features

---

#### Exclude the bulk samples

```{r}
conditions_of_interest <- c("2i", "a2i", "serum")
cells_of_interest <- WhichCells(so_norm_fil, expression = Type %in% conditions_of_interest)

so_norm_fil <- subset(so_norm_fil, cells = cells_of_interest)
```

#### Copy the seurat object to five different objects

```{r copy_objects, message=FALSE, warning=FALSE, include=FALSE}
non_subsetted_no_features_defined <- so_norm_fil
non_subsetted_all_genes_as_features <- so_norm_fil
non_subsetted_mSEGs_as_features <- so_norm_fil
subsetted_no_features_defined <- so_norm_fil
subsetted_mSEGs_as_features <- so_norm_fil
```


### Create the PCA plots

```{r}
custom_colors <- c(
    "2i" = "#1f77b4",  # Blue
    "2i_bulk" = "#ff7f0e",  # Orange
    "a2i" = "#2ca02c",  # Green
    "a2i_bulk" = "#d62728",  # Red
    "serum" = "#9467bd",   # Purple
    "serum_bulk" = "#f5c84e" # yellow
)
```


### PCA Plots
#### 1) Seurat Normalized + Non Subsetted + No features defined


```{r fig.height=10, fig.width=12, fig.align='center'}
set.seed(181)

non_subsetted_no_features_defined <- RunPCA(non_subsetted_no_features_defined, verbose = FALSE)

p1 <- DimPlot(non_subsetted_no_features_defined, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + No features defined (E-MTAB-2600)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 15),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p1)
```


#### 2) Seurat Normalized + Non subsetted + All genes as features


```{r fig.height=10, fig.width=12, fig.align='center'}
set.seed(182)

non_subsetted_all_genes_as_features <- RunPCA(object = non_subsetted_all_genes_as_features, features = rownames(non_subsetted_all_genes_as_features), verbose = FALSE)

p2 <- DimPlot(non_subsetted_all_genes_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + All genes as features (E-MTAB-2600)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p2)
```


#### 3) Seurat Normalized + Non subsetted + mSEGs as features

```{r fig.height=10, fig.width=12, fig.align='center'}
set.seed(183)

non_subsetted_mSEGs_as_features <- RunPCA(object = non_subsetted_mSEGs_as_features, features = mSEG, verbose = FALSE)

p3 <- DimPlot(non_subsetted_mSEGs_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + mSEGs as features (E-MTAB-2600)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p3)
```


#### 4) Seurat Normalized + Subsetted + No features defined

```{r fig.height=10, fig.width=12, fig.align='center'}
set.seed(184)

# First subset the seurat object
subsetted_no_features_defined <- subset(subsetted_no_features_defined, features = mSEG)

subsetted_no_features_defined <- RunPCA(object = subsetted_no_features_defined, verbose = FALSE)

p4 <- DimPlot(subsetted_no_features_defined, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Subsetted + No features defined (E-MTAB-2600)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p4)
```


#### 5) Seurat Normalized + Subsetted + mSEGs as features

```{r fig.height=10, fig.width=12, fig.align='center'}
set.seed(185)

# First subset the seurat object
subsetted_mSEGs_as_features <- subset(subsetted_mSEGs_as_features, features = mSEG)

subsetted_mSEGs_as_features <- RunPCA(object = subsetted_mSEGs_as_features, features = mSEG, verbose = FALSE)

p5 <- DimPlot(subsetted_mSEGs_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Subsetted + mSEGs as features (E-MTAB-2600)") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p5)
```

### Now we need to replot after excluding the outlier 2i cells

> Outlying cells were identified from Seurat Normalized + Non Subsetted + No Features Defined

#### Read in the outliers
```{r}
outliers_df <- read.csv("/home/s2599932/MSc_DSB_Dissertation_2024/01-reproduced-old-dissertation/mouse-analysis/sample_outliers_SN_NS_NF.csv", header = FALSE)
outliers <- outliers_df$X
```

#### 1) Plot 1 - Outlier excluded
```{r fig.height=8,fig.width=10}
set.seed(191)

non_subsetted_no_features_defined <- subset(non_subsetted_no_features_defined, cells = setdiff(Cells(non_subsetted_no_features_defined), outliers))

non_subsetted_no_features_defined <- RunPCA(non_subsetted_no_features_defined, verbose = FALSE)

p1 <- DimPlot(non_subsetted_no_features_defined, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + No features defined (E-MTAB-2600) + No 2i outliers") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 10)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p1)

# Save the plot
png("./deconvolution_normalized_outlier_excluded_plot1.png", width = 10, height = 8, units = "in", res = 400)
print(p1)
dev.off()
```

#### 2) Plot 2 - Outliers excluded
```{r fig.height=8,fig.width=10}
set.seed(192)

non_subsetted_all_genes_as_features <- subset(non_subsetted_all_genes_as_features, cells = setdiff(Cells(non_subsetted_all_genes_as_features), outliers))

non_subsetted_all_genes_as_features <- RunPCA(object = non_subsetted_all_genes_as_features, features = rownames(non_subsetted_all_genes_as_features), verbose = FALSE)

p2 <- DimPlot(non_subsetted_all_genes_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + All genes as features (E-MTAB-2600) + No 2i outliers") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p2)

# Save the plot
png("./deconvolution_normalized_outlier_excluded_plot2.png", width = 10, height = 8, units = "in", res = 400)
print(p2)
dev.off()
```

#### 3) Plot 3 - Outliers excluded
```{r fig.height=8,fig.width=10}
set.seed(193)

non_subsetted_mSEGs_as_features <- subset(non_subsetted_mSEGs_as_features, cells = setdiff(Cells(non_subsetted_mSEGs_as_features), outliers))

non_subsetted_mSEGs_as_features <- RunPCA(object = non_subsetted_mSEGs_as_features, features = mSEG, verbose = FALSE)

p3 <- DimPlot(non_subsetted_mSEGs_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Non Subsetted + mSEGs as features (E-MTAB-2600) + No 2i Outliers") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p3)

# Save the plot
png("./deconvolution_normalized_outlier_excluded_plot3.png", width = 10, height = 8, units = "in", res = 400)
print(p3)
dev.off()
```

#### 4) Plot 4 - Outliers excluded
```{r fig.height=8,fig.width=10}
set.seed(194)

subsetted_no_features_defined <- subset(subsetted_no_features_defined, cells = setdiff(Cells(subsetted_no_features_defined), outliers))

subsetted_no_features_defined <- subset(subsetted_no_features_defined, features = mSEG)

subsetted_no_features_defined <- RunPCA(object = subsetted_no_features_defined, verbose = FALSE)

p4 <- DimPlot(subsetted_no_features_defined, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Subsetted + No features defined (E-MTAB-2600) + No 2i outliers") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p4)

# Save the plot
png("./deconvolution_normalized_outlier_excluded_plot4.png", width = 10, height = 8, units = "in", res = 400)
print(p4)
dev.off()
```

#### Plot 5 - Outliers Excluded
```{r fig.height=8,fig.width=10}
set.seed(195)

subsetted_mSEGs_as_features <- subset(subsetted_mSEGs_as_features, cells = setdiff(Cells(subsetted_mSEGs_as_features), outliers))

subsetted_mSEGs_as_features <- subset(subsetted_mSEGs_as_features, features = mSEG)

subsetted_mSEGs_as_features <- RunPCA(object = subsetted_mSEGs_as_features, features = mSEG, verbose = FALSE)

p5 <- DimPlot(subsetted_mSEGs_as_features, reduction = "pca", group.by = "Type") +
    ggtitle("Deconvolution Normalized + Subsetted + mSEGs as features (E-MTAB-2600) + No 2i outliers") +
    theme_minimal(base_size = 15) +  # Increase base font size for better readability
    scale_color_manual(values = custom_colors) +  # Use a specific viridis color option
    theme(
        plot.title = element_text(hjust = 0.5, size = 13, face = "bold"),  # Center and bold the title
        axis.title.x = element_text(size = 15),  # Increase x-axis title size
        axis.title.y = element_text(size = 15),  # Increase y-axis title size
        axis.text = element_text(size = 12),  # Increase axis text size
        legend.title = element_text(size = 12),  # Increase legend title size
        legend.text = element_text(size = 12)  # Increase legend text size
    ) +
    guides(color = guide_legend(override.aes = list(size = 5)))  # Increase legend point size


print(p5)

# Save the plot
png("./deconvolution_normalized_outlier_excluded_plot5.png", width = 10, height = 8, units = "in", res = 400)
print(p5)
dev.off()
```

# Create heatmap
#### Extract the PCA loadings and embeddings
```{r}
# Subsetted Seurat object with no explicit feature definition
subsetted_no_features_defined_loadings <- Loadings(subsetted_no_features_defined, reduction = "pca")[,1:2]
subsetted_no_features_defined_embeddings <- Embeddings(subsetted_no_features_defined, reduction = "pca")[,1:2]
  
# Subsetted Seurat object with explicit definition of feature
subsetted_mSEGs_as_features_loadings <- Loadings(subsetted_mSEGs_as_features, reduction = "pca")[,1:2]
subsetted_mSEGs_as_features_embeddings <- Embeddings(subsetted_mSEGs_as_features, reduction = "pca")[,1:2]
```
#### Convert to dataframes
```{r}
# Subsetted Seurat object with no explicit feature definition
subsetted_no_features_defined_loadings <- as.data.frame(subsetted_no_features_defined_loadings)
subsetted_no_features_defined_embeddings <- as.data.frame(subsetted_no_features_defined_embeddings)
# Subsetted Seurat object with explicit definition of feature
subsetted_mSEGs_as_features_loadings <- as.data.frame(subsetted_mSEGs_as_features_loadings)
subsetted_mSEGs_as_features_embeddings <- as.data.frame(subsetted_mSEGs_as_features_embeddings)
```

#### Add a new column to the loading dataframes which is the sum of first two principal components
```{r}
# Subsetted Seurat object with no explicit feature definition
subsetted_no_features_defined_loadings$SumOfPCs <- abs(subsetted_no_features_defined_loadings$PC_1) + abs(subsetted_no_features_defined_loadings$PC_2)
# Subsetted Seurat object with explicit definition of feature
subsetted_mSEGs_as_features_loadings$SumofPCs <- abs(subsetted_mSEGs_as_features_loadings)$PC_1 + abs(subsetted_mSEGs_as_features_loadings)$PC_2
```

#### Add a new column to the embedding dataframes which is the sum of first two principal components
```{r}
# Subsetted Seurat object with no explicit feature definition
subsetted_no_features_defined_loadings$SumOfPCs <- abs(subsetted_no_features_defined_loadings$PC_1) + abs(subsetted_no_features_defined_loadings$PC_2)

# Subsetted Seurat object with explicit definition of feature
subsetted_mSEGs_as_features_loadings$SumOfPCs <- abs(subsetted_mSEGs_as_features_loadings$PC_1) + abs(subsetted_mSEGs_as_features_loadings$PC_2)

# Arrange all the dataframes in descending order of SumOfPCs values
subsetted_no_features_defined_loadings <- subsetted_no_features_defined_loadings %>%
  arrange(desc(SumOfPCs))

subsetted_mSEGs_as_features_loadings <- subsetted_mSEGs_as_features_loadings %>%
  arrange(desc(SumOfPCs))

# For embeddings data
subsetted_no_features_defined_embeddings$SumOfPCs <- abs(subsetted_no_features_defined_embeddings$PC_1) + abs(subsetted_no_features_defined_embeddings$PC_2)
subsetted_mSEGs_as_features_embeddings$SumOfPCs <- abs(subsetted_mSEGs_as_features_embeddings$PC_1) + abs(subsetted_mSEGs_as_features_embeddings$PC_2)
```

#### Arrange the dataframes in descending order of the new column values
```{r}

```

# Heatmap with annotation
```{r fig.height=10, fig.width=12}
library(Seurat)
library(dplyr)
library(ComplexHeatmap)
library(circlize)

# Ensure the relevant columns are numeric
subsetted_no_features_defined_loadings <- subsetted_no_features_defined_loadings %>%
  mutate(PC_1 = as.numeric(PC_1), PC_2 = as.numeric(PC_2), SumOfPCs = as.numeric(SumOfPCs))

subsetted_mSEGs_as_features_loadings <- subsetted_mSEGs_as_features_loadings %>%
  mutate(PC_1 = as.numeric(PC_1), PC_2 = as.numeric(PC_2), SumOfPCs = as.numeric(SumOfPCs))

# Identify the top 25 genes from the loadings dataframes based on SumOfPCs
top_genes_no_features <- subsetted_no_features_defined_loadings %>%
  arrange(desc(SumOfPCs)) %>%
  head(9) %>%
  rownames()

top_genes_mSEGs <- subsetted_mSEGs_as_features_loadings %>%
  arrange(desc(SumOfPCs)) %>%
  head(41) %>%
  rownames()

# Subset the Seurat objects based on the top 25 genes
subsetted_no_features_defined_subset <- subset(subsetted_no_features_defined, features = top_genes_no_features)
subsetted_mSEGs_as_features_subset <- subset(subsetted_mSEGs_as_features, features = top_genes_mSEGs)

# Extract the log-normalized counts
lognorm_counts_no_features <- as.matrix(GetAssayData(subsetted_no_features_defined_subset, slot = "data"))
lognorm_counts_mSEGs <- as.matrix(GetAssayData(subsetted_mSEGs_as_features_subset, slot = "data"))

# Normalize columns using the provided function
normalize_columns <- function(x) {
  (x - mean(x)) / sd(x)
}

lognorm_counts_no_features <- t(apply(lognorm_counts_no_features, 1, normalize_columns))
lognorm_counts_mSEGs <- t(apply(lognorm_counts_mSEGs, 1, normalize_columns))

# Transpose the matrices to have genes as columns and samples as rows
lognorm_counts_no_features <- t(lognorm_counts_no_features)
lognorm_counts_mSEGs <- t(lognorm_counts_mSEGs)

# Extract cell type annotations
cell_types_no_features <- as.factor(subsetted_no_features_defined_subset@meta.data$Type)
cell_types_mSEGs <- as.factor(subsetted_mSEGs_as_features_subset@meta.data$Type)

# Create a row annotation for cell types
row_annotation_no_features <- rowAnnotation(CellType = cell_types_no_features,
                                            col = list(CellType = c("2i" = "purple", "a2i" = "orange", "serum" = "darkgreen")))

row_annotation_mSEGs <- rowAnnotation(CellType = cell_types_mSEGs,
                                      col = list(CellType = c("2i" = "purple", "a2i" = "orange", "serum" = "darkgreen")))

# Create heatmaps
# Heatmap for subsetted_no_features_defined_subset
Heatmap(lognorm_counts_no_features, name = "LogNormalized Counts No Features",
        cluster_rows = TRUE, cluster_columns = TRUE,
        show_row_names = FALSE, show_column_names = TRUE,
        heatmap_legend_param = list(title = "LogNormalized Counts"),
        column_title = "Genes", row_title = "Samples",
        right_annotation = row_annotation_no_features)

# Heatmap for subsetted_mSEGs_as_features_subset
Heatmap(lognorm_counts_mSEGs, name = "LogNormalized Counts mSEGs",
        cluster_rows = TRUE, cluster_columns = TRUE,
        show_row_names = FALSE, show_column_names = TRUE,
        heatmap_legend_param = list(title = "LogNormalized Counts"),
        column_title = "Genes", row_title = "Samples",
        right_annotation = row_annotation_mSEGs)
```

# Heatmap of all genes as a reference
```{r fig.height=10, fig.width=12}
# Extract the normalized counts matrix
lognorm_counts <- as.matrix(GetAssayData(subsetted_no_features_defined, slot = "data"))

# Normalize columns using the provided function
normalize_columns <- function(x) {
  (x - mean(x)) / sd(x)
}

lognorm_counts <- t(apply(lognorm_counts, 1, normalize_columns))

# Transpose the matrices to have genes as columns and samples as rows
lognorm_counts <- t(lognorm_counts)

# Check for NA/NaN/Inf values and handle them
lognorm_counts[is.na(lognorm_counts)] <- 0  # Replace NA values with 0
lognorm_counts[is.nan(lognorm_counts)] <- 0  # Replace NaN values with 0
lognorm_counts[is.infinite(lognorm_counts)] <- 0  # Replace Inf values with 0

# Create the annotation
cell_types <- as.factor(subsetted_no_features_defined_subset@meta.data$Type)
row_annotation <- rowAnnotation(CellType = cell_types,
                                col = list(CellType = c("2i" = "purple", "a2i" = "orange", "serum" = "darkgreen")))

# Generate the heatmap
Heatmap(lognorm_counts, name = "LogNormalized Counts No Features",
        cluster_rows = TRUE, cluster_columns = TRUE,
        show_row_names = FALSE, show_column_names = FALSE,
        heatmap_legend_param = list(title = "LogNormalized Counts"),
        column_title = "Genes", row_title = "Samples",
        right_annotation = row_annotation)
```